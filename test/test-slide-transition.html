<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ»‘å‹•è½‰å ´æ•ˆæœæ¸¬è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react@18/umd/react.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* æ»‘å‹•è½‰å ´å‹•ç•« */
        @keyframes slideInFromRight {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(0);
            }
        }

        @keyframes slideInFromLeft {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(0);
            }
        }

        @keyframes slideOutToLeft {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-100%);
            }
        }

        @keyframes slideOutToRight {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;

        function SlideTransitionTest() {
            // æ»‘å‹•è½‰å ´ç‹€æ…‹
            const [isSliding, setIsSliding] = useState(false);
            const [currentImage, setCurrentImage] = useState(null);
            const [nextImage, setNextImage] = useState(null);
            const [slideDirection, setSlideDirection] = useState('left');

            const [currentImageIndex, setCurrentImageIndex] = useState(0);

            // ç°¡å–®çš„åœ–ç‰‡URLç”Ÿæˆ
            const getImageUrl = (index) => `https://picsum.photos/400/300?random=${index + 1000}`;

            const [displayImage, setDisplayImage] = useState(getImageUrl(0));

            // ç°¡å–®çš„é è¼‰å…¥ç·©å­˜
            const imageCache = useRef(new Map());
            const [cacheSize, setCacheSize] = useState(0);

            // åœ–ç‰‡é è¼‰å…¥å‡½æ•¸ - å¼·åˆ¶ç€è¦½å™¨ç·©å­˜
            const preloadImage = (url) => {
                return new Promise((resolve, reject) => {
                    if (!url) {
                        resolve(null);
                        return;
                    }

                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“é è¼‰å…¥
                    if (preloadedImagesRef.current.has(url)) {
                        console.log('ğŸ¯ åœ–ç‰‡å·²åœ¨ç·©å­˜ä¸­:', url);
                        resolve(preloadedImagesRef.current.get(url));
                        return;
                    }

                    const img = new Image();
                    img.crossOrigin = 'anonymous'; // é¿å… CORS å•é¡Œ

                    img.onload = () => {
                        console.log('âœ… åœ–ç‰‡é è¼‰å…¥æˆåŠŸ:', url);
                        // å­˜å„²åˆ°ç·©å­˜
                        preloadedImagesRef.current.set(url, img);
                        resolve(img);
                    };

                    img.onerror = (error) => {
                        console.warn('âš ï¸ åœ–ç‰‡é è¼‰å…¥å¤±æ•—:', url, error);
                        reject(error);
                    };

                    img.src = url;

                    // è¨­ç½®è¶…æ™‚
                    setTimeout(() => {
                        reject(new Error('åœ–ç‰‡è¼‰å…¥è¶…æ™‚'));
                    }, 5000);
                });
            };

            // ä½¿ç”¨ ref ä¾†é¿å…ä¾è³´å•é¡Œ
            const preloadedImagesRef = useRef(new Map());

            // æ»‘å‹•çª—å£é è¼‰å…¥ç®¡ç†ï¼ˆæ”¯æŒç„¡é™æ»‘å‹•ï¼‰
            const managePreloadWindow = useCallback(async (centerIndex) => {
                const windowSize = 5; // é è¼‰å…¥çª—å£å¤§å°
                const cleanupThreshold = 8; // è¶…é8å¼µè·é›¢æ‰æ¸…ç†

                console.log(`ğŸ”„ ç®¡ç†é è¼‰å…¥çª—å£ï¼Œä¸­å¿ƒç´¢å¼•: ${centerIndex}`);

                // è¨ˆç®—éœ€è¦é è¼‰å…¥çš„ç¯„åœï¼ˆæ”¯æŒè² æ•¸ç´¢å¼•ï¼‰
                const startIndex = centerIndex - Math.floor(windowSize / 2);
                const endIndex = centerIndex + Math.floor(windowSize / 2);

                const currentPreloaded = preloadedImagesRef.current;
                const newPreloadedImages = new Map(currentPreloaded);

                // é è¼‰å…¥çª—å£å…§çš„åœ–ç‰‡
                for (let i = startIndex; i <= endIndex; i++) {
                    const url = getImageUrl(i);
                    if (!newPreloadedImages.has(url)) {
                        try {
                            console.log(`â³ é è¼‰å…¥æ–°åœ–ç‰‡ [${i}]:`, url);
                            const img = await preloadImage(url);
                            newPreloadedImages.set(url, img);
                            console.log(`âœ… åœ–ç‰‡ [${i}] é è¼‰å…¥å®Œæˆ`);
                        } catch (error) {
                            console.warn(`âŒ åœ–ç‰‡ [${i}] é è¼‰å…¥å¤±æ•—:`, error.message);
                        }
                    }
                }

                // æ¸…ç†è¶…å‡ºç¯„åœçš„åœ–ç‰‡ï¼ˆåŸºæ–¼ç´¢å¼•è·é›¢ï¼‰
                const imagesToRemove = [];
                for (const [url] of newPreloadedImages) {
                    // å¾URLä¸­æå–ç´¢å¼•
                    const match = url.match(/random=(\d+)/);
                    if (match) {
                        const imageIndex = parseInt(match[1]) - 1000; // æ¸›å»åç§»é‡
                        const distance = Math.abs(imageIndex - centerIndex);
                        if (distance > cleanupThreshold) {
                            imagesToRemove.push(url);
                        }
                    }
                }

                if (imagesToRemove.length > 0) {
                    console.log(`ğŸ§¹ æ¸…ç† ${imagesToRemove.length} å¼µè¶…å‡ºç¯„åœçš„åœ–ç‰‡:`, imagesToRemove);
                    imagesToRemove.forEach(url => newPreloadedImages.delete(url));
                }

                // æ›´æ–° ref å’Œ state
                preloadedImagesRef.current = newPreloadedImages;
                setPreloadedImages(newPreloadedImages);
                console.log(`ğŸ“Š é è¼‰å…¥æ± ç‹€æ…‹ - å¤§å°: ${newPreloadedImages.size}, çª—å£: [${startIndex}-${endIndex}]`);
            }, []);

            // åˆå§‹é è¼‰å…¥
            useEffect(() => {
                console.log('ğŸš€ åˆå§‹åŒ–é è¼‰å…¥çª—å£...');
                managePreloadWindow(currentImageIndex);
            }, []);

            // ç•¶åœ–ç‰‡ç´¢å¼•æ”¹è®Šæ™‚æ›´æ–°é è¼‰å…¥çª—å£ï¼ˆé¿å…åœ¨æ»‘å‹•æ™‚å¹²æ“¾ï¼‰
            useEffect(() => {
                if (!isSliding) {
                    console.log(`ğŸ“‹ ç´¢å¼•è®Šæ›´è§¸ç™¼é è¼‰å…¥ç®¡ç†: ${currentImageIndex}`);
                    managePreloadWindow(currentImageIndex);
                } else {
                    console.log(`â¸ï¸ æ»‘å‹•ä¸­ï¼Œå»¶é²é è¼‰å…¥ç®¡ç†: ${currentImageIndex}`);
                    // æ»‘å‹•çµæŸå¾Œå†åŸ·è¡Œé è¼‰å…¥ç®¡ç†
                    const timer = setTimeout(() => {
                        console.log(`â° å»¶é²åŸ·è¡Œé è¼‰å…¥ç®¡ç†: ${currentImageIndex}`);
                        managePreloadWindow(currentImageIndex);
                    }, 350); // æ¯”æ»‘å‹•å‹•ç•«ç¨é•·ä¸€é»

                    return () => clearTimeout(timer);
                }
            }, [currentImageIndex, isSliding]); // ç§»é™¤ managePreloadWindow ä¾è³´ï¼Œé¿å…ç„¡é™å¾ªç’°

            // æ»‘å‹•è½‰å ´å‡½æ•¸ï¼ˆç¢ºä¿ä½¿ç”¨é è¼‰å…¥ç·©å­˜ï¼‰
            const triggerSlideTransition = useCallback((newImageUrl, direction = 'left') => {
                if (isSliding) return;

                const currentImg = displayImage;
                const newImg = newImageUrl;

                // æª¢æŸ¥åœ–ç‰‡æ˜¯å¦å·²é è¼‰å…¥
                const isPreloaded = preloadedImagesRef.current.has(newImg);
                console.log('ğŸ” æ»‘å‹•è½‰å ´æª¢æŸ¥:');
                console.log('  ç›®æ¨™åœ–ç‰‡:', newImg);
                console.log('  æ˜¯å¦å·²é è¼‰å…¥:', isPreloaded);
                console.log('  ç·©å­˜å¤§å°:', preloadedImagesRef.current.size);

                if (!isPreloaded) {
                    console.log('âŒ åœ–ç‰‡æœªé è¼‰å…¥ï¼ç«‹å³é è¼‰å…¥...');
                    // å¦‚æœæ²’æœ‰é è¼‰å…¥ï¼Œç«‹å³é è¼‰å…¥
                    preloadImage(newImg).then(() => {
                        console.log('ğŸš€ ç·Šæ€¥é è¼‰å…¥å®Œæˆï¼Œé–‹å§‹æ»‘å‹•');
                        startSlideAnimation();
                    }).catch(() => {
                        console.log('âš ï¸ ç·Šæ€¥é è¼‰å…¥å¤±æ•—ï¼Œä»ç„¶é–‹å§‹æ»‘å‹•');
                        startSlideAnimation();
                    });
                } else {
                    console.log('âœ… åœ–ç‰‡å·²é è¼‰å…¥ï¼Œç«‹å³é–‹å§‹æ»‘å‹•');
                    startSlideAnimation();
                }

                function startSlideAnimation() {
                    setCurrentImage(currentImg);
                    setNextImage(newImg);
                    setSlideDirection(direction);
                    setIsSliding(true);

                    // 300mså¾Œå®Œæˆå‹•ç•«ä¸¦æ›´æ–°é¡¯ç¤ºåœ–ç‰‡
                    setTimeout(() => {
                        setIsSliding(false);
                        setCurrentImage(null);
                        setNextImage(null);
                        setDisplayImage(newImg);
                    }, 300);
                }
            }, [displayImage, isSliding]);

            // ä¸‹ä¸€å¼µåœ–ç‰‡ï¼ˆç„¡é™æ»‘å‹•ï¼‰
            const goToNextImage = () => {
                const nextIndex = currentImageIndex + 1;
                const nextImageUrl = getImageUrl(nextIndex);
                console.log(`ğŸ¯ ç”¨æˆ¶é»æ“Šä¸‹ä¸€å¼µ: ${currentImageIndex} â†’ ${nextIndex}`);
                console.log(`ğŸ“‹ ç”Ÿæˆçš„åœ–ç‰‡URL: ${nextImageUrl}`);
                console.log(`ğŸ” ç•¶å‰é è¼‰å…¥æ± ç‹€æ…‹:`, Array.from(preloadedImages.keys()));

                // æª¢æŸ¥ç›®æ¨™åœ–ç‰‡æ˜¯å¦å·²é è¼‰å…¥
                if (preloadedImages.has(nextImageUrl)) {
                    console.log('âœ… ç›®æ¨™åœ–ç‰‡å·²é è¼‰å…¥ï¼Œå¯ä»¥å®‰å…¨æ»‘å‹•');
                } else {
                    console.log('âš ï¸ ç›®æ¨™åœ–ç‰‡æœªé è¼‰å…¥ï¼Œå¯èƒ½å‡ºç¾ç°è‰²ç•«é¢');
                }

                // å…ˆé–‹å§‹æ»‘å‹•å‹•ç•«ï¼Œé¿å…è¢«é è¼‰å…¥éç¨‹å¹²æ“¾
                triggerSlideTransition(nextImageUrl, 'left');

                // ç„¶å¾Œæ›´æ–°ç´¢å¼•ï¼ˆé€™æœƒè§¸ç™¼é è¼‰å…¥ï¼Œä½†ä¸æœƒå½±éŸ¿ç•¶å‰å‹•ç•«ï¼‰
                setCurrentImageIndex(nextIndex);
            };

            // ä¸Šä¸€å¼µåœ–ç‰‡ï¼ˆæ”¯æŒè² æ•¸ç´¢å¼•ï¼‰
            const goToPrevImage = () => {
                const prevIndex = currentImageIndex - 1;
                const prevImageUrl = getImageUrl(prevIndex);
                console.log(`ğŸ¯ ç”¨æˆ¶é»æ“Šä¸Šä¸€å¼µ: ${currentImageIndex} â†’ ${prevIndex}`);

                // å…ˆé–‹å§‹æ»‘å‹•å‹•ç•«ï¼Œé¿å…è¢«é è¼‰å…¥éç¨‹å¹²æ“¾
                triggerSlideTransition(prevImageUrl, 'right');

                // ç„¶å¾Œæ›´æ–°ç´¢å¼•ï¼ˆé€™æœƒè§¸ç™¼é è¼‰å…¥ï¼Œä½†ä¸æœƒå½±éŸ¿ç•¶å‰å‹•ç•«ï¼‰
                setCurrentImageIndex(prevIndex);
            };

            return (
                <div className="max-w-2xl mx-auto">
                    <h1 className="text-3xl font-bold text-center mb-8">æ»‘å‹•è½‰å ´æ•ˆæœæ¸¬è©¦</h1>
                    
                    {/* åœ–ç‰‡é¡¯ç¤ºå€åŸŸ */}
                    <div className="relative w-full h-64 mb-6 rounded-lg overflow-hidden bg-gray-200">
                        {/* æ»‘å‹•è½‰å ´å®¹å™¨ */}
                        {isSliding && (currentImage || nextImage) ? (
                            <div className="absolute inset-0 overflow-hidden">
                                {/* ç•¶å‰åœ–ç‰‡ - æ»‘å‡º */}
                                {currentImage && (
                                    <div
                                        className="absolute inset-0 w-full h-full"
                                        style={{
                                            backgroundImage: `url(${currentImage})`,
                                            backgroundSize: 'cover',
                                            backgroundPosition: 'center',
                                            transform: 'translateX(0)',
                                            animation: slideDirection === 'left' ? 'slideOutToLeft 300ms ease-out forwards' : 'slideOutToRight 300ms ease-out forwards',
                                            zIndex: 1
                                        }}
                                    />
                                )}
                                {/* ä¸‹ä¸€å¼µåœ–ç‰‡ - å¾å³å´æ»‘å…¥ */}
                                {nextImage && (
                                    <div
                                        className="absolute inset-0 w-full h-full"
                                        style={{
                                            backgroundImage: `url(${nextImage})`,
                                            backgroundSize: 'cover',
                                            backgroundPosition: 'center',
                                            transform: slideDirection === 'left' ? 'translateX(100%)' : 'translateX(-100%)',
                                            animation: slideDirection === 'left' ? 'slideInFromRight 300ms ease-out forwards' : 'slideInFromLeft 300ms ease-out forwards',
                                            zIndex: 2
                                        }}
                                    />
                                )}
                            </div>
                        ) : (
                            /* æ­£å¸¸é¡¯ç¤ºç‹€æ…‹ */
                            <div 
                                className="absolute inset-0"
                                style={{
                                    backgroundImage: `url(${displayImage})`,
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center'
                                }}
                            />
                        )}

                        {/* ç‹€æ…‹æŒ‡ç¤ºå™¨ */}
                        <div className="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded">
                            {isSliding ? 'æ»‘å‹•ä¸­...' : `åœ–ç‰‡ç´¢å¼•: ${currentImageIndex}`}
                        </div>

                        {/* é è¼‰å…¥ç‹€æ…‹æŒ‡ç¤ºå™¨ */}
                        <div className="absolute top-4 right-4 bg-blue-600 bg-opacity-80 text-white px-3 py-1 rounded text-sm">
                            é è¼‰å…¥æ± : {preloadedImages.size}å¼µ
                        </div>

                        {/* é è¼‰å…¥è©³ç´°ç‹€æ…‹ */}
                        <div className="absolute bottom-4 left-4 bg-green-600 bg-opacity-80 text-white px-3 py-1 rounded text-xs">
                            {preloadedImages.has(displayImage) ? 'âœ… ç•¶å‰åœ–ç‰‡å·²é è¼‰' : 'âš ï¸ ç•¶å‰åœ–ç‰‡æœªé è¼‰'}
                        </div>
                    </div>
                    
                    {/* æ§åˆ¶æŒ‰éˆ• */}
                    <div className="flex justify-center gap-4">
                        <button
                            onClick={goToPrevImage}
                            disabled={isSliding}
                            className="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            â† ä¸Šä¸€å¼µ
                        </button>
                        <button
                            onClick={goToNextImage}
                            disabled={isSliding}
                            className="px-6 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            ä¸‹ä¸€å¼µ â†’
                        </button>
                    </div>
                    
                    {/* èªªæ˜ */}
                    <div className="mt-8 p-4 bg-blue-50 rounded-lg">
                        <h3 className="font-bold mb-2">ç„¡é™æ»‘å‹•é è¼‰å…¥æ¸¬è©¦ï¼š</h3>
                        <ul className="list-disc list-inside space-y-1 text-sm">
                            <li>é»æ“Šã€Œä¸‹ä¸€å¼µã€æŒ‰éˆ•æ¸¬è©¦å·¦æ»‘æ•ˆæœï¼ˆæ–°åœ–ç‰‡å¾å³å´æ»‘å…¥ï¼‰</li>
                            <li>é»æ“Šã€Œä¸Šä¸€å¼µã€æŒ‰éˆ•æ¸¬è©¦å³æ»‘æ•ˆæœï¼ˆæ–°åœ–ç‰‡å¾å·¦å´æ»‘å…¥ï¼‰</li>
                            <li><strong>ç„¡é™æ»‘å‹•</strong>ï¼šæ¨¡æ“¬çœŸå¯¦æƒ…æ³ï¼Œå¯ä»¥ç„¡é™å¾€å‰æˆ–å¾€å¾Œæ»‘å‹•ï¼Œæ¯å¼µéƒ½æ˜¯æ–°åœ–ç‰‡</li>
                            <li><strong>é è¼‰å…¥ç­–ç•¥</strong>ï¼šç¶­æŒç•¶å‰åœ–ç‰‡å‰å¾Œå„2å¼µçš„é è¼‰å…¥çª—å£ï¼ˆå…±5å¼µï¼‰</li>
                            <li><strong>å‹•æ…‹ç®¡ç†</strong>ï¼šåˆ‡æ›åœ–ç‰‡æ™‚è‡ªå‹•é è¼‰å…¥æ–°ç¯„åœï¼Œè¶…é8å¼µè·é›¢æ‰æ¸…ç†è¨˜æ†¶é«”</li>
                            <li><strong>ç‹€æ…‹é¡¯ç¤º</strong>ï¼šå·¦ä¸Šè§’é¡¯ç¤ºç•¶å‰ç´¢å¼•ï¼Œå³ä¸Šè§’é¡¯ç¤ºé è¼‰å…¥æ± å¤§å°</li>
                            <li>å‹•ç•«æ™‚é•·ç‚º 300msï¼Œä½¿ç”¨ ease-out ç·©å‹•å‡½æ•¸</li>
                        </ul>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<SlideTransitionTest />, document.getElementById('root'));
    </script>
</body>
</html>
