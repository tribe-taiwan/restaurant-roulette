<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hooks 實現測試 - 安全的狀態管理</title>
    
    <!-- 載入樣式 -->
    <link rel="stylesheet" href="../components/shared/garmin-design-system.css">
    <link rel="stylesheet" href="../components/shared/shared-components.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: var(--background-color);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--surface-color);
            border-radius: var(--border-radius-large);
            box-shadow: var(--shadow-md);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: var(--font-weight-semibold);
            margin-bottom: 16px;
            color: var(--primary-color);
        }
        
        .status-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }
        
        .status-healthy {
            background: var(--success-color);
            color: white;
        }
        
        .status-error {
            background: var(--error-color);
            color: white;
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }
        
        .test-button {
            padding: 8px 16px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius-medium);
            cursor: pointer;
            font-size: 14px;
            min-height: 36px;
        }
        
        .test-button:hover {
            background: var(--primary-color-hover);
        }
        
        .test-button.secondary {
            background: var(--secondary-color);
        }
        
        .test-button.danger {
            background: var(--error-color);
        }
        
        .test-output {
            background: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-medium);
            padding: 12px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .hook-info {
            background: var(--info-color-light);
            border-left: 4px solid var(--info-color);
            padding: 12px;
            margin: 12px 0;
        }
        
        .error-display {
            background: var(--error-color-light);
            border-left: 4px solid var(--error-color);
            padding: 12px;
            margin: 12px 0;
            color: var(--error-color-dark);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Hooks 實現測試 - 安全的狀態管理</h1>
        <p>測試 useLocationManager 和 useSearchSettings Hooks 的安全性和功能性</p>
        
        <div class="test-grid">
            <!-- useLocationManager 測試 -->
            <div class="test-section">
                <h2 class="test-title">
                    useLocationManager Hook 測試
                    <span id="location-status" class="status-indicator">載入中...</span>
                </h2>
                
                <div class="hook-info">
                    <strong>Hook ID:</strong> <span id="location-hook-id">-</span><br>
                    <strong>健康狀態:</strong> <span id="location-health">-</span><br>
                    <strong>位置狀態:</strong> <span id="location-location-status">-</span>
                </div>
                
                <div class="test-controls">
                    <button class="test-button" onclick="testLocationManager()">初始化測試</button>
                    <button class="test-button" onclick="testGetCurrentLocation()">獲取位置</button>
                    <button class="test-button" onclick="testGeocodeAddress()">地址解析</button>
                    <button class="test-button secondary" onclick="testLocationHealthCheck()">健康檢查</button>
                    <button class="test-button danger" onclick="testLocationErrorHandling()">錯誤處理</button>
                </div>
                
                <div id="location-output" class="test-output"></div>
                <div id="location-error" class="error-display" style="display: none;"></div>
            </div>
            
            <!-- useSearchSettings 測試 -->
            <div class="test-section">
                <h2 class="test-title">
                    useSearchSettings Hook 測試
                    <span id="settings-status" class="status-indicator">載入中...</span>
                </h2>
                
                <div class="hook-info">
                    <strong>Hook ID:</strong> <span id="settings-hook-id">-</span><br>
                    <strong>健康狀態:</strong> <span id="settings-health">-</span><br>
                    <strong>用餐時段:</strong> <span id="settings-meal-time">-</span><br>
                    <strong>搜索距離:</strong> <span id="settings-distance">-</span>
                </div>
                
                <div class="test-controls">
                    <button class="test-button" onclick="testSearchSettings()">初始化測試</button>
                    <button class="test-button" onclick="testMealTimeChange()">變更用餐時段</button>
                    <button class="test-button" onclick="testDistanceChange()">變更距離</button>
                    <button class="test-button secondary" onclick="testSettingsHealthCheck()">健康檢查</button>
                    <button class="test-button danger" onclick="testSettingsErrorHandling()">錯誤處理</button>
                </div>
                
                <div id="settings-output" class="test-output"></div>
                <div id="settings-error" class="error-display" style="display: none;"></div>
            </div>
        </div>
        
        <!-- 組件間通信測試 -->
        <div class="test-section">
            <h2 class="test-title">組件間通信測試</h2>
            
            <div class="test-controls">
                <button class="test-button" onclick="testComponentCommunication()">測試事件通信</button>
                <button class="test-button" onclick="testEventSubscription()">測試事件訂閱</button>
                <button class="test-button secondary" onclick="showCommunicationStats()">顯示統計</button>
                <button class="test-button danger" onclick="testCommunicationCleanup()">測試清理</button>
            </div>
            
            <div id="communication-output" class="test-output"></div>
        </div>
        
        <!-- 錯誤邊界測試 -->
        <div class="test-section">
            <h2 class="test-title">錯誤邊界測試</h2>
            
            <div class="test-controls">
                <button class="test-button" onclick="testErrorBoundary()">測試錯誤捕獲</button>
                <button class="test-button" onclick="testErrorReporting()">測試錯誤報告</button>
                <button class="test-button secondary" onclick="showErrorReports()">顯示錯誤報告</button>
                <button class="test-button danger" onclick="clearErrorReports()">清除錯誤報告</button>
            </div>
            
            <div id="error-boundary-output" class="test-output"></div>
        </div>
    </div>

    <!-- 載入依賴 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 載入組件和工具 -->
    <script src="../utils/componentCommunication.js"></script>
    <script src="../components/shared/ErrorBoundary.js"></script>
    <script src="../hooks/useLocationManager.js"></script>
    <script src="../hooks/useSearchSettings.js"></script>
    
    <script>
        // 全局測試狀態
        let locationHook = null;
        let settingsHook = null;
        let testResults = [];
        
        // 日誌函數
        function log(message, target = 'general') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            console.log(logMessage);
            
            const outputElement = document.getElementById(`${target}-output`);
            if (outputElement) {
                outputElement.innerHTML += logMessage + '\n';
                outputElement.scrollTop = outputElement.scrollHeight;
            }
        }
        
        function showError(message, target) {
            const errorElement = document.getElementById(`${target}-error`);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        function hideError(target) {
            const errorElement = document.getElementById(`${target}-error`);
            if (errorElement) {
                errorElement.style.display = 'none';
            }
        }
        
        // useLocationManager 測試
        function testLocationManager() {
            try {
                log('初始化 useLocationManager Hook...', 'location');
                
                // 創建測試組件
                function TestLocationComponent() {
                    locationHook = useLocationManager();
                    
                    React.useEffect(() => {
                        updateLocationDisplay();
                    }, [locationHook]);
                    
                    return null;
                }
                
                // 渲染測試組件
                const container = document.createElement('div');
                ReactDOM.render(React.createElement(TestLocationComponent), container);
                
                log('useLocationManager Hook 初始化成功', 'location');
                updateLocationDisplay();
                hideError('location');
                
            } catch (error) {
                log(`初始化失敗: ${error.message}`, 'location');
                showError(error.message, 'location');
            }
        }
        
        function updateLocationDisplay() {
            if (!locationHook) return;
            
            document.getElementById('location-hook-id').textContent = locationHook.hookId || 'N/A';
            document.getElementById('location-health').textContent = locationHook.isHookHealthy ? '健康' : '異常';
            document.getElementById('location-location-status').textContent = locationHook.locationStatus || 'N/A';
            
            const statusElement = document.getElementById('location-status');
            if (locationHook.isHookHealthy) {
                statusElement.textContent = '正常';
                statusElement.className = 'status-indicator status-healthy';
            } else {
                statusElement.textContent = '異常';
                statusElement.className = 'status-indicator status-error';
            }
        }
        
        async function testGetCurrentLocation() {
            if (!locationHook) {
                log('請先初始化 Hook', 'location');
                return;
            }
            
            try {
                log('測試獲取當前位置...', 'location');
                const result = await locationHook.getCurrentLocation();
                log(`位置獲取結果: ${JSON.stringify(result, null, 2)}`, 'location');
                updateLocationDisplay();
            } catch (error) {
                log(`獲取位置失敗: ${error.message}`, 'location');
            }
        }
        
        async function testGeocodeAddress() {
            if (!locationHook) {
                log('請先初始化 Hook', 'location');
                return;
            }
            
            try {
                log('測試地址解析...', 'location');
                const testAddress = '台北市信義區市府路1號';
                const result = await locationHook.geocodeAddress(testAddress);
                log(`地址解析結果: ${JSON.stringify(result, null, 2)}`, 'location');
                updateLocationDisplay();
            } catch (error) {
                log(`地址解析失敗: ${error.message}`, 'location');
            }
        }
        
        function testLocationHealthCheck() {
            if (!locationHook) {
                log('請先初始化 Hook', 'location');
                return;
            }
            
            try {
                log('執行健康檢查...', 'location');
                const isHealthy = locationHook.performHealthCheck();
                log(`健康檢查結果: ${isHealthy ? '通過' : '失敗'}`, 'location');
                updateLocationDisplay();
            } catch (error) {
                log(`健康檢查失敗: ${error.message}`, 'location');
            }
        }
        
        function testLocationErrorHandling() {
            if (!locationHook) {
                log('請先初始化 Hook', 'location');
                return;
            }
            
            try {
                log('測試錯誤處理機制...', 'location');
                
                // 測試無效參數
                locationHook.geocodeAddress('');
                locationHook.saveQuickLocation('invalid', null, null);
                
                log('錯誤處理測試完成', 'location');
                updateLocationDisplay();
            } catch (error) {
                log(`錯誤處理測試失敗: ${error.message}`, 'location');
            }
        }
        
        // useSearchSettings 測試
        function testSearchSettings() {
            try {
                log('初始化 useSearchSettings Hook...', 'settings');
                
                function TestSettingsComponent() {
                    settingsHook = useSearchSettings();
                    
                    React.useEffect(() => {
                        updateSettingsDisplay();
                    }, [settingsHook]);
                    
                    return null;
                }
                
                const container = document.createElement('div');
                ReactDOM.render(React.createElement(TestSettingsComponent), container);
                
                log('useSearchSettings Hook 初始化成功', 'settings');
                updateSettingsDisplay();
                hideError('settings');
                
            } catch (error) {
                log(`初始化失敗: ${error.message}`, 'settings');
                showError(error.message, 'settings');
            }
        }
        
        function updateSettingsDisplay() {
            if (!settingsHook) return;
            
            document.getElementById('settings-hook-id').textContent = settingsHook.hookId || 'N/A';
            document.getElementById('settings-health').textContent = settingsHook.isHookHealthy ? '健康' : '異常';
            document.getElementById('settings-meal-time').textContent = settingsHook.selectedMealTime || 'N/A';
            document.getElementById('settings-distance').textContent = settingsHook.getDistanceDisplayText() || 'N/A';
            
            const statusElement = document.getElementById('settings-status');
            if (settingsHook.isHookHealthy) {
                statusElement.textContent = '正常';
                statusElement.className = 'status-indicator status-healthy';
            } else {
                statusElement.textContent = '異常';
                statusElement.className = 'status-indicator status-error';
            }
        }
        
        function testMealTimeChange() {
            if (!settingsHook) {
                log('請先初始化 Hook', 'settings');
                return;
            }
            
            try {
                log('測試用餐時段變更...', 'settings');
                const mealTimes = ['breakfast', 'lunch', 'dinner', 'all'];
                const randomMealTime = mealTimes[Math.floor(Math.random() * mealTimes.length)];
                
                const result = settingsHook.setSelectedMealTime(randomMealTime);
                log(`用餐時段變更為 ${randomMealTime}: ${result ? '成功' : '失敗'}`, 'settings');
                updateSettingsDisplay();
            } catch (error) {
                log(`用餐時段變更失敗: ${error.message}`, 'settings');
            }
        }
        
        function testDistanceChange() {
            if (!settingsHook) {
                log('請先初始化 Hook', 'settings');
                return;
            }
            
            try {
                log('測試距離變更...', 'settings');
                const newMultiplier = Math.floor(Math.random() * 10) + 1;
                
                const result = settingsHook.setUnitMultiplier(newMultiplier);
                log(`距離倍數變更為 ${newMultiplier}: ${result ? '成功' : '失敗'}`, 'settings');
                updateSettingsDisplay();
            } catch (error) {
                log(`距離變更失敗: ${error.message}`, 'settings');
            }
        }
        
        function testSettingsHealthCheck() {
            if (!settingsHook) {
                log('請先初始化 Hook', 'settings');
                return;
            }
            
            try {
                log('執行健康檢查...', 'settings');
                const isHealthy = settingsHook.performHealthCheck();
                log(`健康檢查結果: ${isHealthy ? '通過' : '失敗'}`, 'settings');
                updateSettingsDisplay();
            } catch (error) {
                log(`健康檢查失敗: ${error.message}`, 'settings');
            }
        }
        
        function testSettingsErrorHandling() {
            if (!settingsHook) {
                log('請先初始化 Hook', 'settings');
                return;
            }
            
            try {
                log('測試錯誤處理機制...', 'settings');
                
                // 測試無效參數
                settingsHook.setSelectedMealTime('invalid');
                settingsHook.setUnitMultiplier(-1);
                settingsHook.setBaseUnit(999);
                
                log('錯誤處理測試完成', 'settings');
                updateSettingsDisplay();
            } catch (error) {
                log(`錯誤處理測試失敗: ${error.message}`, 'settings');
            }
        }
        
        // 組件間通信測試
        function testComponentCommunication() {
            try {
                log('測試組件間通信...', 'communication');
                
                if (!window.componentComm) {
                    log('ComponentCommunication 系統未載入', 'communication');
                    return;
                }
                
                // 測試事件發送
                const testData = { message: '測試訊息', timestamp: Date.now() };
                const result = window.componentComm.emit('test-event', testData);
                log(`事件發送結果: ${result}`, 'communication');
                
                // 測試事件訂閱
                const unsubscribe = window.componentComm.subscribe('test-response', (data) => {
                    log(`收到回應事件: ${JSON.stringify(data)}`, 'communication');
                });
                
                // 發送回應事件
                setTimeout(() => {
                    window.componentComm.emit('test-response', { response: '測試回應' });
                    unsubscribe();
                }, 1000);
                
            } catch (error) {
                log(`組件間通信測試失敗: ${error.message}`, 'communication');
            }
        }
        
        function testEventSubscription() {
            try {
                log('測試事件訂閱機制...', 'communication');
                
                if (!window.componentComm) {
                    log('ComponentCommunication 系統未載入', 'communication');
                    return;
                }
                
                // 訂閱多個事件
                const events = ['location-updated', 'meal-time-changed', 'distance-changed'];
                const unsubscribers = [];
                
                events.forEach(eventType => {
                    const unsubscribe = window.componentComm.subscribe(eventType, (data) => {
                        log(`收到 ${eventType} 事件: ${JSON.stringify(data)}`, 'communication');
                    });
                    unsubscribers.push(unsubscribe);
                });
                
                log(`已訂閱 ${events.length} 個事件`, 'communication');
                
                // 5秒後清理訂閱
                setTimeout(() => {
                    unsubscribers.forEach(unsubscribe => unsubscribe());
                    log('已清理所有事件訂閱', 'communication');
                }, 5000);
                
            } catch (error) {
                log(`事件訂閱測試失敗: ${error.message}`, 'communication');
            }
        }
        
        function showCommunicationStats() {
            try {
                if (!window.componentComm) {
                    log('ComponentCommunication 系統未載入', 'communication');
                    return;
                }
                
                const stats = window.componentComm.getSubscriberStats();
                log(`訂閱者統計: ${JSON.stringify(stats, null, 2)}`, 'communication');
            } catch (error) {
                log(`獲取統計失敗: ${error.message}`, 'communication');
            }
        }
        
        function testCommunicationCleanup() {
            try {
                if (!window.componentComm) {
                    log('ComponentCommunication 系統未載入', 'communication');
                    return;
                }
                
                const clearedCount = window.componentComm.clearAllSubscribers();
                log(`已清理 ${clearedCount} 個訂閱者`, 'communication');
            } catch (error) {
                log(`清理測試失敗: ${error.message}`, 'communication');
            }
        }
        
        // 錯誤邊界測試
        function testErrorBoundary() {
            try {
                log('測試錯誤邊界...', 'error-boundary');
                
                if (!window.ErrorBoundary) {
                    log('ErrorBoundary 組件未載入', 'error-boundary');
                    return;
                }
                
                // 創建會拋出錯誤的組件
                function ErrorComponent() {
                    throw new Error('測試錯誤');
                }
                
                function TestErrorBoundary() {
                    return React.createElement(window.ErrorBoundary, {
                        fallback: ({ error, onRetry }) => {
                            return React.createElement('div', null, [
                                React.createElement('p', { key: 'error' }, `捕獲錯誤: ${error.message}`),
                                React.createElement('button', { 
                                    key: 'retry', 
                                    onClick: onRetry 
                                }, '重試')
                            ]);
                        }
                    }, React.createElement(ErrorComponent));
                }
                
                const container = document.createElement('div');
                ReactDOM.render(React.createElement(TestErrorBoundary), container);
                
                log('錯誤邊界測試完成', 'error-boundary');
                
            } catch (error) {
                log(`錯誤邊界測試失敗: ${error.message}`, 'error-boundary');
            }
        }
        
        function testErrorReporting() {
            try {
                log('測試錯誤報告...', 'error-boundary');
                
                if (!window.ErrorReportingUtils) {
                    log('ErrorReportingUtils 未載入', 'error-boundary');
                    return;
                }
                
                const reports = window.ErrorReportingUtils.getStoredErrorReports();
                log(`目前有 ${reports.length} 個錯誤報告`, 'error-boundary');
                
            } catch (error) {
                log(`錯誤報告測試失敗: ${error.message}`, 'error-boundary');
            }
        }
        
        function showErrorReports() {
            try {
                if (!window.ErrorReportingUtils) {
                    log('ErrorReportingUtils 未載入', 'error-boundary');
                    return;
                }
                
                const reports = window.ErrorReportingUtils.getStoredErrorReports();
                log(`錯誤報告: ${JSON.stringify(reports, null, 2)}`, 'error-boundary');
                
            } catch (error) {
                log(`顯示錯誤報告失敗: ${error.message}`, 'error-boundary');
            }
        }
        
        function clearErrorReports() {
            try {
                if (!window.ErrorReportingUtils) {
                    log('ErrorReportingUtils 未載入', 'error-boundary');
                    return;
                }
                
                const result = window.ErrorReportingUtils.clearErrorReports();
                log(`清除錯誤報告: ${result ? '成功' : '失敗'}`, 'error-boundary');
                
            } catch (error) {
                log(`清除錯誤報告失敗: ${error.message}`, 'error-boundary');
            }
        }
        
        // 頁面載入完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('頁面載入完成，開始初始化測試環境...', 'general');
            
            // 檢查依賴
            const dependencies = [
                { name: 'React', check: () => typeof React !== 'undefined' },
                { name: 'ReactDOM', check: () => typeof ReactDOM !== 'undefined' },
                { name: 'ComponentCommunication', check: () => typeof window.componentComm !== 'undefined' },
                { name: 'ErrorBoundary', check: () => typeof window.ErrorBoundary !== 'undefined' },
                { name: 'useLocationManager', check: () => typeof window.useLocationManager !== 'undefined' },
                { name: 'useSearchSettings', check: () => typeof window.useSearchSettings !== 'undefined' }
            ];
            
            dependencies.forEach(dep => {
                const isLoaded = dep.check();
                console.log(`${dep.name}: ${isLoaded ? '✓' : '✗'}`);
            });
            
            log('測試環境初始化完成', 'general');
        });
    </script>
</body>
</html>