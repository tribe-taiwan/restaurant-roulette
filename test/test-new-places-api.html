<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–° Places API æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 20px 0; padding: 15px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 10px; }
        .restaurant-count { font-weight: bold; color: #d9534f; }
        .restaurant-list { max-height: 300px; overflow-y: auto; font-size: 12px; line-height: 1.4; }
        .restaurant-item { border-bottom: 1px solid #eee; padding: 5px 0; }
    </style>
</head>
<body>
    <h1>æ–° Places API æ¸¬è©¦ (google.maps.places.Place)</h1>
    
    <div class="test-section">
        <h2>æ¸¬è©¦: ä½¿ç”¨æ–° Places API æœç´¢é¤å»³</h2>
        <button onclick="testNewPlacesAPI()">åŸ·è¡Œæ–° API æ¸¬è©¦</button>
        <div id="newApiResult" class="result"></div>
    </div>

    <!-- è¼‰å…¥ä¸»é…ç½®æª”æ¡ˆä»¥ç²å– API KEY -->
    <script src="../utils/locationUtils.js"></script>
    <script>
        // æ¸¬è©¦ç”¨çš„å°å—ä½ç½®
        const testLocation = { lat: 22.9908, lng: 120.2133 };
        
        let map;
        let placesLibrary;

        // åˆå§‹åŒ–æ–°çš„ Places API
        async function initNewPlacesAPI() {
            if (window.google && window.google.maps) {
                console.log('âœ… Google Maps API å·²è¼‰å…¥ï¼Œåˆå§‹åŒ– Places Library');
                
                // å‰µå»ºåœ°åœ–ï¼ˆæ–° API éœ€è¦ï¼‰
                const mapDiv = document.createElement('div');
                mapDiv.style.display = 'none';
                document.body.appendChild(mapDiv);
                
                map = new google.maps.Map(mapDiv, {
                    center: testLocation,
                    zoom: 15,
                    mapId: 'DEMO_MAP_ID' // æ–° API å»ºè­°ä½¿ç”¨ Map ID
                });
                
                // è¼‰å…¥ Places Library
                const { Place } = await google.maps.importLibrary("places");
                placesLibrary = { Place };
                
                console.log('âœ… æ–° Places API åˆå§‹åŒ–å®Œæˆ');
                return true;
            }
            
            // å‹•æ…‹è¼‰å…¥ Google Maps API
            console.log('ğŸ“¡ è¼‰å…¥ Google Maps API...');
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_PLACES_CONFIG.API_KEY}&libraries=places&loading=async&callback=onNewGoogleMapsLoaded`;
            script.async = true;
            document.head.appendChild(script);
            
            return false;
        }

        // Google Maps API è¼‰å…¥å®Œæˆå›èª¿
        window.onNewGoogleMapsLoaded = async function() {
            console.log('âœ… Google Maps API è¼‰å…¥å®Œæˆ');
            await initNewPlacesAPI();
        };

        // æ¸¬è©¦æ–° Places API
        async function testNewPlacesAPI() {
            const resultDiv = document.getElementById('newApiResult');
            resultDiv.innerHTML = '<p>ğŸ” åŸ·è¡Œæ–° Places API æ¸¬è©¦...</p>';
            
            try {
                // ç¢ºä¿ API å·²åˆå§‹åŒ–
                if (!placesLibrary) {
                    const initialized = await initNewPlacesAPI();
                    if (!initialized) {
                        resultDiv.innerHTML = '<p>â³ æ­£åœ¨è¼‰å…¥ Google Maps APIï¼Œè«‹ç¨å¾Œå†è©¦...</p>';
                        return;
                    }
                }

                console.log('ğŸ” é–‹å§‹ä½¿ç”¨æ–° Places API æœç´¢é¤å»³...');
                
                const allRestaurants = new Set();
                const searchResults = [];
                
                // å®šç¾©å¤šå€‹æœç´¢å€åŸŸ
                const searchAreas = [
                    { name: 'ä¸­å¿ƒé»', lat: testLocation.lat, lng: testLocation.lng },
                    { name: 'åŒ—æ–¹ 0.5km', lat: testLocation.lat + 0.005, lng: testLocation.lng },
                    { name: 'å—æ–¹ 0.5km', lat: testLocation.lat - 0.005, lng: testLocation.lng },
                    { name: 'æ±æ–¹ 0.5km', lat: testLocation.lat, lng: testLocation.lng + 0.005 },
                    { name: 'è¥¿æ–¹ 0.5km', lat: testLocation.lat, lng: testLocation.lng - 0.005 }
                ];

                for (let i = 0; i < searchAreas.length; i++) {
                    const area = searchAreas[i];
                    console.log(`ğŸ¯ æœç´¢å€åŸŸ ${i+1}: ${area.name}`);
                    
                    try {
                        // ä½¿ç”¨æ–° Places API çš„ searchNearby æ–¹æ³•
                        const request = {
                            fields: ['displayName', 'location', 'rating', 'userRatingCount', 'priceLevel', 'types', 'id'],
                            locationRestriction: {
                                center: { lat: area.lat, lng: area.lng },
                                radius: 1000 // 1km ç¯„åœ
                            },
                            includedTypes: ['restaurant', 'meal_takeaway', 'cafe'],
                            maxResultCount: 20
                            // ç§»é™¤ languageCode - æ–° API ä¸æ”¯æ´æ­¤åƒæ•¸
                        };

                        console.log('ğŸ“¡ ç™¼é€æ–° API æœç´¢è«‹æ±‚...', request);
                        
                        // ä½¿ç”¨æ–°çš„ searchNearby æ–¹æ³•
                        const { places } = await placesLibrary.Place.searchNearby(request);
                        
                        console.log(`ğŸ“Š å€åŸŸ ${area.name} æ‰¾åˆ° ${places.length} å®¶é¤å»³`);
                        
                        const areaRestaurants = [];
                        places.forEach(place => {
                            if (!allRestaurants.has(place.id)) {
                                allRestaurants.add(place.id);
                                areaRestaurants.push({
                                    id: place.id,
                                    name: place.displayName,
                                    rating: place.rating || 0,
                                    userRatingCount: place.userRatingCount || 0,
                                    types: place.types || []
                                });
                            }
                        });
                        
                        searchResults.push({
                            area: area.name,
                            count: places.length,
                            newRestaurants: areaRestaurants.length,
                            restaurants: areaRestaurants
                        });
                        
                    } catch (error) {
                        console.error(`âŒ å€åŸŸ ${area.name} æœç´¢å¤±æ•—:`, error);
                        searchResults.push({
                            area: area.name,
                            count: 0,
                            newRestaurants: 0,
                            restaurants: [],
                            error: error.message
                        });
                    }
                }

                // é¡¯ç¤ºçµæœ
                let html = `<h3>ğŸ†• æ–° Places API æœç´¢çµæœ</h3>`;
                html += `<p class="restaurant-count">ç¸½è¨ˆæ‰¾åˆ° ${allRestaurants.size} å®¶ä¸é‡è¤‡é¤å»³</p>`;
                
                searchResults.forEach((result, index) => {
                    const statusColor = result.error ? '#dc3545' : '#28a745';
                    html += `<div style="border-left: 3px solid ${statusColor}; padding-left: 10px; margin: 10px 0;">`;
                    html += `<strong>${result.area}:</strong> æ‰¾åˆ° ${result.count} å®¶é¤å»³ (æ–°å¢ ${result.newRestaurants} å®¶)<br>`;
                    
                    if (result.error) {
                        html += `<small style="color: #dc3545;">éŒ¯èª¤: ${result.error}</small><br>`;
                    }
                    
                    if (result.restaurants.length > 0) {
                        html += `<div class="restaurant-list">`;
                        result.restaurants.forEach(restaurant => {
                            html += `<div class="restaurant-item">`;
                            html += `<strong>${restaurant.name}</strong> `;
                            html += `(è©•åˆ†: ${restaurant.rating.toFixed(1)}, `;
                            html += `${restaurant.userRatingCount} å‰‡è©•è«–)`;
                            html += `</div>`;
                        });
                        html += `</div>`;
                    }
                    html += `</div>`;
                });
                
                resultDiv.innerHTML = html;
                
                console.log('ğŸ‰ æ–° Places API æ¸¬è©¦å®Œæˆï¼Œç¸½è¨ˆ:', allRestaurants.size, 'å®¶é¤å»³');

            } catch (error) {
                console.error('âŒ æ–° Places API æ¸¬è©¦å¤±æ•—:', error);
                resultDiv.innerHTML = `<p style="color: #dc3545;">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</p>`;
            }
        }

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸš€ æ–° Places API æ¸¬è©¦é é¢å·²è¼‰å…¥');
            console.log('ğŸ“ æ¸¬è©¦ä½ç½®: å°å—è»Šç«™é™„è¿‘', testLocation);
        };
    </script>
</body>
</html>
