<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿç”¢æª”èª¿è©¦</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react@18/umd/react.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://resource.trickle.so/vendor_lib/unpkg/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div id="root">
        <div class="text-center">
            <h1 class="text-2xl font-bold mb-4">ç”Ÿç”¢æª”èª¿è©¦</h1>
            <div id="status" class="text-lg">è¼‰å…¥ä¸­...</div>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸»é…ç½® -->
    <script src="../utils/locationUtils.js"></script>

    <script>
        console.log('ğŸ” é–‹å§‹ç”Ÿç”¢æª”èª¿è©¦...');

        // æ•ç²æ‰€æœ‰éŒ¯èª¤
        window.addEventListener('error', (e) => {
            console.error('âŒ å…¨å±€éŒ¯èª¤:', e.error);
            document.getElementById('status').innerHTML += `<div class="text-red-600">éŒ¯èª¤: ${e.error.message}</div>`;
        });

        // è¼‰å…¥æœ¬åœ° API Key
        console.log('ğŸ“¡ è¼‰å…¥æœ¬åœ° API Key...');
        fetch('../_local/.api_key')
            .then(response => response.text())
            .then(apiKey => {
                if (window.GOOGLE_PLACES_CONFIG) {
                    window.GOOGLE_PLACES_CONFIG.API_KEY = apiKey.trim();
                    console.log('âœ… æ¸¬è©¦é é¢ï¼šæœ¬åœ° API Key å·²è¼‰å…¥');
                } else {
                    console.error('âŒ GOOGLE_PLACES_CONFIG æœªå®šç¾©');
                }
            })
            .catch(error => {
                console.error('âŒ æ¸¬è©¦é é¢ï¼šç„¡æ³•è®€å– .api_key æª”æ¡ˆ:', error);
            });

        // ç­‰å¾…API Keyè¼‰å…¥å®Œæˆ
        async function waitForAPIKey() {
            let attempts = 0;
            while (attempts < 20) {
                if (window.GOOGLE_PLACES_CONFIG &&
                    window.GOOGLE_PLACES_CONFIG.API_KEY &&
                    !window.GOOGLE_PLACES_CONFIG.API_KEY.includes('%%')) {
                    console.log('âœ… API Keyå·²å°±ç·’:', window.GOOGLE_PLACES_CONFIG.API_KEY.substring(0, 8) + 'xxxxxxxx');
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, 200));
                attempts++;
            }
            throw new Error('API Keyè¼‰å…¥è¶…æ™‚');
        }

        // æ¨¡æ“¬ç”Ÿç”¢ç’°å¢ƒçš„å…¨å±€å‡½æ•¸
        window.getPriceLabels = () => ({
            zh: { 1: 'ä¾¿å®œ', 2: 'ä¸­ç­‰', 3: 'æ˜‚è²´', 4: 'å¾ˆè²´' },
            en: { 1: 'Cheap', 2: 'Moderate', 3: 'Expensive', 4: 'Very Expensive' }
        });

        window.renderStars = (rating) => {
            if (!rating) return null;
            const stars = [];
            for (let i = 1; i <= 5; i++) {
                stars.push({
                    key: i,
                    className: i <= rating ? 'text-yellow-400' : 'text-gray-300',
                    symbol: 'â˜…'
                });
            }
            return stars;
        };

        window.getDirectionsUrl = (restaurant, userLocation, userAddress, language) => {
            return `https://www.google.com/maps/dir/?api=1&destination=${restaurant.name}`;
        };

        // ä¸»æ¸¬è©¦å‡½æ•¸
        async function runTest() {
            try {
                // ç­‰å¾… API Key è¼‰å…¥
                await waitForAPIKey();

                // æ¸¬è©¦è¼‰å…¥ SlotMachine.js
                const response = await fetch('/components/SlotMachine.js');
                console.log('ğŸ“¡ SlotMachine.js éŸ¿æ‡‰ç‹€æ…‹:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const code = await response.text();
                console.log('ğŸ“„ SlotMachine.js è¼‰å…¥æˆåŠŸï¼Œå¤§å°:', code.length);

                // æª¢æŸ¥ä»£ç¢¼å…§å®¹
                const hasSlideStates = code.includes('isSliding') && code.includes('currentImage');
                const hasSlideFunction = code.includes('triggerSlideTransition');
                const hasSlideJSX = code.includes('æ»‘å‹•è½‰å ´å®¹å™¨');

                console.log('ğŸ” ä»£ç¢¼æª¢æŸ¥:');
                console.log('  æ»‘å‹•ç‹€æ…‹:', hasSlideStates);
                console.log('  æ»‘å‹•å‡½æ•¸:', hasSlideFunction);
                console.log('  æ»‘å‹•JSX:', hasSlideJSX);
                
                // å˜—è©¦ç”¨ Babel è½‰æ›
                try {
                    console.log('ğŸ”„ é–‹å§‹ Babel è½‰æ›...');
                    const transformed = Babel.transform(code, {
                        presets: ['react']
                    });
                    console.log('âœ… Babel è½‰æ›æˆåŠŸ');
                    
                    // åŸ·è¡Œè½‰æ›å¾Œçš„ä»£ç¢¼
                    console.log('ğŸš€ åŸ·è¡Œçµ„ä»¶ä»£ç¢¼...');
                    eval(transformed.code);
                    
                    if (typeof window.SlotMachine === 'function') {
                        console.log('âœ… SlotMachine çµ„ä»¶å·²å®šç¾©');
                        
                        // æ¸¬è©¦çµ„ä»¶å¯¦ä¾‹åŒ–
                        try {
                            const testProps = {
                                isSpinning: false,
                                onSpin: () => console.log('Spin clicked'),
                                onAddCandidate: () => console.log('Add candidate'),
                                translations: { spinButton: 'é–‹å§‹æœå°‹', spinning: 'æœå°‹ä¸­...' },
                                finalRestaurant: {
                                    name: 'æ¸¬è©¦é¤å»³',
                                    image: 'https://picsum.photos/400/300?random=1'
                                },
                                candidateList: [],
                                language: 'zh',
                                onClearList: () => console.log('Clear list'),
                                onImageClick: () => console.log('Image clicked'),
                                userLocation: { lat: 22.9908, lng: 120.2133 },
                                userAddress: 'å°å—å¸‚',
                                onPreviousRestaurant: () => console.log('Previous restaurant')
                            };
                            
                            console.log('ğŸ§ª æ¸¬è©¦çµ„ä»¶æ¸²æŸ“...');
                            const element = React.createElement(window.SlotMachine, testProps);
                            ReactDOM.render(element, document.getElementById('root'));
                            
                            console.log('âœ… çµ„ä»¶æ¸²æŸ“æˆåŠŸ');
                            
                            // æ¸¬è©¦æ»‘å‹•è½‰å ´
                            setTimeout(() => {
                                console.log('ğŸ”„ æ¸¬è©¦æ»‘å‹•è½‰å ´...');
                                // æ¨¡æ“¬é¤å»³è®ŠåŒ– - ä½¿ç”¨ä¸åŒçš„åœ–ç‰‡
                                const newProps = {
                                    ...testProps,
                                    finalRestaurant: {
                                        name: 'æ–°é¤å»³',
                                        image: 'https://picsum.photos/400/300?random=99'  // ä½¿ç”¨ä¸åŒçš„éš¨æ©Ÿåœ–ç‰‡
                                    }
                                };
                                const newElement = React.createElement(window.SlotMachine, newProps);
                                ReactDOM.render(newElement, document.getElementById('root'));
                                console.log('ğŸ¯ æ»‘å‹•è½‰å ´æ¸¬è©¦å®Œæˆ');

                                // å†æ¬¡æ¸¬è©¦æ»‘å‹•è½‰å ´
                                setTimeout(() => {
                                    console.log('ğŸ”„ ç¬¬äºŒæ¬¡æ»‘å‹•è½‰å ´æ¸¬è©¦...');
                                    const thirdProps = {
                                        ...testProps,
                                        finalRestaurant: {
                                            name: 'ç¬¬ä¸‰å®¶é¤å»³',
                                            image: 'https://picsum.photos/400/300?random=88'  // åˆä¸€å€‹ä¸åŒçš„åœ–ç‰‡
                                        }
                                    };
                                    const thirdElement = React.createElement(window.SlotMachine, thirdProps);
                                    ReactDOM.render(thirdElement, document.getElementById('root'));
                                    console.log('ğŸ¯ ç¬¬äºŒæ¬¡æ»‘å‹•è½‰å ´æ¸¬è©¦å®Œæˆ');
                                }, 2000);
                            }, 2000);
                            
                        } catch (renderError) {
                            console.error('âŒ çµ„ä»¶æ¸²æŸ“å¤±æ•—:', renderError);
                            document.getElementById('root').innerHTML = `
                                <div class="text-center">
                                    <h1 class="text-2xl font-bold mb-4 text-red-600">âŒ çµ„ä»¶æ¸²æŸ“å¤±æ•—</h1>
                                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                                        <strong>éŒ¯èª¤:</strong> ${renderError.message}
                                    </div>
                                </div>
                            `;
                        }
                        
                    } else {
                        throw new Error('SlotMachine çµ„ä»¶æœªå®šç¾©');
                    }
                    
                } catch (babelError) {
                    console.error('âŒ Babel è½‰æ›å¤±æ•—:', babelError);
                    document.getElementById('root').innerHTML = `
                        <div class="text-center">
                            <h1 class="text-2xl font-bold mb-4 text-red-600">âŒ Babel è½‰æ›å¤±æ•—</h1>
                            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                                <strong>éŒ¯èª¤:</strong> ${babelError.message}<br>
                                <strong>è¡Œè™Ÿ:</strong> ${babelError.loc ? babelError.loc.line : 'æœªçŸ¥'}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ æ¸¬è©¦å¤±æ•—:', error);
                document.getElementById('root').innerHTML = `
                    <div class="text-center">
                        <h1 class="text-2xl font-bold mb-4 text-red-600">âŒ æ¸¬è©¦å¤±æ•—</h1>
                        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
                            <strong>éŒ¯èª¤:</strong> ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // å•Ÿå‹•æ¸¬è©¦
        runTest();
    </script>
</body>
</html>
