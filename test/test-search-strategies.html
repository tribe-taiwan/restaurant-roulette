<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤å»³æœç´¢ç­–ç•¥æ¸¬è©¦ (æ–° API)</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 20px 0; padding: 15px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 10px; }
        .restaurant-count { font-weight: bold; color: #d9534f; }
        .restaurant-list { max-height: 200px; overflow-y: auto; font-size: 12px; }
        .api-version { background: #e7f3ff; border: 1px solid #bee5eb; padding: 8px; border-radius: 4px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <h1>é¤å»³æœç´¢ç­–ç•¥æ¸¬è©¦ (ä½¿ç”¨æ–° Places API)</h1>
    
    <div class="api-version">
        <strong>ğŸ†• API ç‰ˆæœ¬:</strong> ä½¿ç”¨ Google Places API (New) - google.maps.places.Place
    </div>
    
    <div class="test-section">
        <h2>æ¸¬è©¦ 1: éš¨æ©Ÿåç§»æœç´¢ä¸­å¿ƒé»</h2>
        <p><em>èªªæ˜ï¼šåœ¨ä¸­å¿ƒé»å‘¨åœéš¨æ©Ÿåç§»é€²è¡Œå¤šæ¬¡æœç´¢ï¼Œæª¢æŸ¥é‡è¤‡ç‡å•é¡Œ</em></p>
        <button onclick="testRandomOffset()">åŸ·è¡Œéš¨æ©Ÿåç§»æ¸¬è©¦</button>
        <div id="randomOffsetResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦ 2: æŒ‰è·¯åæœç´¢</h2>
        <p><em>èªªæ˜ï¼šåŸºæ–¼åœ°ç†ä½ç½®ç²å–é™„è¿‘é“è·¯ï¼Œåœ¨æ¯æ¢è·¯ä¸Šæœç´¢é¤å»³</em></p>
        <button onclick="testStreetSearch()">åŸ·è¡Œè·¯åæœç´¢æ¸¬è©¦</button>
        <div id="streetSearchResult" class="result"></div>
    </div>

    <!-- è¼‰å…¥ä¸»é…ç½®æª”æ¡ˆä»¥ç²å– API KEY (éç¡¬ç·¨ç¢¼) -->
    <script src="../utils/locationUtils.js"></script>
    <script>
        // æ¸¬è©¦ç”¨çš„å°å—ä½ç½®
        const testLocation = { lat: 22.9908, lng: 120.2133 }; // å°å—è»Šç«™é™„è¿‘
        
        let map;
        let placesLibrary;

        // åˆå§‹åŒ–æ–°çš„ Places API
        async function initNewPlacesAPI() {
            if (window.google && window.google.maps) {
                console.log('âœ… Google Maps API å·²è¼‰å…¥ï¼Œåˆå§‹åŒ– Places Library');
                
                // å‰µå»ºåœ°åœ–ï¼ˆæ–° API éœ€è¦ï¼‰
                const mapDiv = document.createElement('div');
                mapDiv.style.display = 'none';
                document.body.appendChild(mapDiv);
                
                map = new google.maps.Map(mapDiv, {
                    center: testLocation,
                    zoom: 15,
                    mapId: 'DEMO_MAP_ID'
                });
                
                // è¼‰å…¥ Places Library
                const { Place } = await google.maps.importLibrary("places");
                placesLibrary = { Place };
                
                console.log('âœ… æ–° Places API åˆå§‹åŒ–å®Œæˆ');
                return true;
            }
            
            // å‹•æ…‹è¼‰å…¥ Google Maps API (å¾ locationUtils.js ç²å– API é‡‘é‘°)
            console.log('ğŸ“¡ è¼‰å…¥ Google Maps API...');
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_PLACES_CONFIG.API_KEY}&libraries=places&loading=async&callback=onGoogleMapsLoaded`;
            script.async = true;
            document.head.appendChild(script);
            
            return false;
        }

        // Google Maps API è¼‰å…¥å®Œæˆå›èª¿
        window.onGoogleMapsLoaded = async function() {
            console.log('âœ… Google Maps API è¼‰å…¥å®Œæˆ');
            await initNewPlacesAPI();
        };

        // ä½¿ç”¨æ–° Places API é€²è¡Œæœç´¢
        async function searchWithNewAPI(location, radius = 1000) {
            if (!placesLibrary) {
                throw new Error('Places Library å°šæœªåˆå§‹åŒ–');
            }

            const request = {
                fields: ['displayName', 'id', 'location', 'rating', 'userRatingCount', 'priceLevel', 'types'],
                locationRestriction: {
                    center: location,
                    radius: radius,
                },
                includedTypes: ['restaurant', 'meal_takeaway', 'food'],
                maxResultCount: 20,
            };

            console.log('ğŸ“¡ ç™¼é€æ–° API æœç´¢è«‹æ±‚...', request);

            try {
                const { places } = await placesLibrary.Place.searchNearby(request);
                console.log(`ğŸ“Š æ‰¾åˆ° ${places.length} å®¶é¤å»³`);
                
                return places.map(place => ({
                    place_id: place.id,
                    name: place.displayName,
                    rating: place.rating,
                    user_ratings_total: place.userRatingCount,
                    price_level: place.priceLevel,
                    types: place.types,
                    geometry: {
                        location: {
                            lat: () => place.location.lat,
                            lng: () => place.location.lng
                        }
                    }
                }));
            } catch (error) {
                console.error('âŒ æ–° API æœç´¢å¤±æ•—:', error);
                throw error;
            }
        }

        // æ¸¬è©¦ 1: éš¨æ©Ÿåç§»æœç´¢
        async function testRandomOffset() {
            const resultDiv = document.getElementById('randomOffsetResult');
            resultDiv.innerHTML = '<p>ğŸ” åŸ·è¡Œéš¨æ©Ÿåç§»æœç´¢æ¸¬è©¦...</p>';
            
            try {
                // ç¢ºä¿ API å·²åˆå§‹åŒ–
                if (!placesLibrary) {
                    const initialized = await initNewPlacesAPI();
                    if (!initialized) {
                        resultDiv.innerHTML = '<p>â³ æ­£åœ¨è¼‰å…¥ Google Maps APIï¼Œè«‹ç¨å¾Œå†è©¦...</p>';
                        return;
                    }
                }

                const allRestaurants = new Map(); // ä½¿ç”¨ Map è¿½è¹¤é‡è¤‡ç‡
                const searchResults = [];
                
                // åŸ·è¡Œ 5 æ¬¡éš¨æ©Ÿåç§»æœç´¢
                for (let i = 0; i < 5; i++) {
                    // éš¨æ©Ÿåç§» 500 ç±³
                    const randomOffset = 0.005;
                    const offsetLat = testLocation.lat + (Math.random() - 0.5) * randomOffset;
                    const offsetLng = testLocation.lng + (Math.random() - 0.5) * randomOffset;
                    const searchLocation = { lat: offsetLat, lng: offsetLng };
                    
                    console.log(`ğŸ² ç¬¬${i+1}æ¬¡éš¨æ©Ÿåç§»æœç´¢:`, searchLocation);
                    
                    try {
                        const restaurants = await searchWithNewAPI(searchLocation);
                        
                        let newCount = 0;
                        restaurants.forEach(r => {
                            if (!allRestaurants.has(r.place_id)) {
                                allRestaurants.set(r.place_id, r);
                                newCount++;
                            }
                        });
                        
                        searchResults.push({
                            attempt: i + 1,
                            location: searchLocation,
                            count: restaurants.length,
                            newCount: newCount,
                            duplicateRate: restaurants.length > 0 ? ((restaurants.length - newCount) / restaurants.length * 100).toFixed(1) : 0,
                            restaurants: restaurants.map(r => r.name)
                        });
                        
                    } catch (error) {
                        console.error(`âŒ ç¬¬${i+1}æ¬¡æœç´¢å¤±æ•—:`, error);
                        searchResults.push({
                            attempt: i + 1,
                            location: searchLocation,
                            error: error.message
                        });
                    }
                }
                
                // è¨ˆç®—æ•´é«”é‡è¤‡ç‡
                const totalSearched = searchResults.reduce((sum, result) => sum + (result.count || 0), 0);
                const overallDuplicateRate = totalSearched > 0 ? ((totalSearched - allRestaurants.size) / totalSearched * 100).toFixed(1) : 0;
                
                // é¡¯ç¤ºçµæœ
                let html = `<h3>ğŸ² éš¨æ©Ÿåç§»æœç´¢çµæœ (æ–° API)</h3>`;
                html += `<p class="restaurant-count">ç¸½è¨ˆæ‰¾åˆ° ${allRestaurants.size} å®¶ä¸é‡è¤‡é¤å»³</p>`;
                html += `<p><strong>æ•´é«”é‡è¤‡ç‡:</strong> ${overallDuplicateRate}% (${totalSearched} æ¬¡çµæœä¸­æœ‰ ${totalSearched - allRestaurants.size} å€‹é‡è¤‡)</p>`;
                
                searchResults.forEach(result => {
                    html += `<div style="border-left: 3px solid #007bff; padding-left: 10px; margin: 10px 0;">`;
                    if (result.error) {
                        html += `<strong>ç¬¬${result.attempt}æ¬¡:</strong> <span style="color: red;">å¤±æ•— - ${result.error}</span><br>`;
                    } else {
                        html += `<strong>ç¬¬${result.attempt}æ¬¡:</strong> æ‰¾åˆ° ${result.count} å®¶é¤å»³ (æ–°å¢ ${result.newCount} å®¶ï¼Œé‡è¤‡ç‡ ${result.duplicateRate}%)<br>`;
                        html += `<small>ä½ç½®: ${result.location.lat.toFixed(4)}, ${result.location.lng.toFixed(4)}</small><br>`;
                        html += `<div class="restaurant-list">${result.restaurants.join(', ')}</div>`;
                    }
                    html += `</div>`;
                });
                
                resultDiv.innerHTML = html;
                
                console.log('ğŸ² éš¨æ©Ÿåç§»æœç´¢å®Œæˆï¼Œç¸½è¨ˆ:', allRestaurants.size, 'å®¶é¤å»³ï¼Œæ•´é«”é‡è¤‡ç‡:', overallDuplicateRate + '%');
                
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</p>`;
            }
        }

        // æ¸¬è©¦ 2: æŒ‰è·¯åæœç´¢
        async function testStreetSearch() {
            const resultDiv = document.getElementById('streetSearchResult');
            resultDiv.innerHTML = '<p>ğŸ›£ï¸ åŸ·è¡Œè·¯åæœç´¢æ¸¬è©¦...</p>';
            
            try {
                // ç¢ºä¿ API å·²åˆå§‹åŒ–
                if (!placesLibrary) {
                    const initialized = await initNewPlacesAPI();
                    if (!initialized) {
                        resultDiv.innerHTML = '<p>â³ æ­£åœ¨è¼‰å…¥ Google Maps APIï¼Œè«‹ç¨å¾Œå†è©¦...</p>';
                        return;
                    }
                }

                const allRestaurants = new Map();
                const searchResults = [];
                
                // åŸºæ–¼è·é›¢åç§»çš„æœç´¢å€åŸŸ (æ¨¡æ“¬ä¸åŒè·¯æ®µ)
                const searchAreas = [
                    { name: 'ä¸­å¿ƒå€åŸŸ', lat: testLocation.lat, lng: testLocation.lng },
                    { name: 'åŒ—å€ (ä¸­å±±è·¯ä¸€å¸¶)', lat: testLocation.lat + 0.008, lng: testLocation.lng },
                    { name: 'å—å€ (æˆåŠŸè·¯ä¸€å¸¶)', lat: testLocation.lat - 0.008, lng: testLocation.lng },
                    { name: 'æ±å€ (æ±é–€è·¯ä¸€å¸¶)', lat: testLocation.lat, lng: testLocation.lng + 0.010 },
                    { name: 'è¥¿å€ (è¥¿é–€è·¯ä¸€å¸¶)', lat: testLocation.lat, lng: testLocation.lng - 0.010 },
                    { name: 'æ±åŒ—å€ (è‚²æ¨‚è¡—ä¸€å¸¶)', lat: testLocation.lat + 0.006, lng: testLocation.lng + 0.008 },
                    { name: 'è¥¿å—å€ (å¥åº·è·¯ä¸€å¸¶)', lat: testLocation.lat - 0.006, lng: testLocation.lng - 0.008 }
                ];

                for (let i = 0; i < searchAreas.length; i++) {
                    const area = searchAreas[i];
                    console.log(`ğŸ›£ï¸ ç¬¬${i+1}å€‹å€åŸŸæœç´¢: ${area.name}`);
                    
                    try {
                        const restaurants = await searchWithNewAPI(area, 800); // è¼ƒå°çš„æœç´¢åŠå¾‘
                        
                        let newCount = 0;
                        restaurants.forEach(r => {
                            if (!allRestaurants.has(r.place_id)) {
                                allRestaurants.set(r.place_id, r);
                                newCount++;
                            }
                        });
                        
                        searchResults.push({
                            area: area.name,
                            location: area,
                            count: restaurants.length,
                            newCount: newCount,
                            duplicateRate: restaurants.length > 0 ? ((restaurants.length - newCount) / restaurants.length * 100).toFixed(1) : 0,
                            restaurants: restaurants.map(r => r.name)
                        });
                        
                    } catch (error) {
                        console.error(`âŒ ${area.name} æœç´¢å¤±æ•—:`, error);
                        searchResults.push({
                            area: area.name,
                            location: area,
                            error: error.message
                        });
                    }
                }
                
                // è¨ˆç®—æ•´é«”é‡è¤‡ç‡
                const totalSearched = searchResults.reduce((sum, result) => sum + (result.count || 0), 0);
                const overallDuplicateRate = totalSearched > 0 ? ((totalSearched - allRestaurants.size) / totalSearched * 100).toFixed(1) : 0;
                
                // é¡¯ç¤ºçµæœ
                let html = `<h3>ğŸ›£ï¸ è·¯åæœç´¢çµæœ (æ–° API)</h3>`;
                html += `<p class="restaurant-count">ç¸½è¨ˆæ‰¾åˆ° ${allRestaurants.size} å®¶ä¸é‡è¤‡é¤å»³</p>`;
                html += `<p><strong>æ•´é«”é‡è¤‡ç‡:</strong> ${overallDuplicateRate}% (${totalSearched} æ¬¡çµæœä¸­æœ‰ ${totalSearched - allRestaurants.size} å€‹é‡è¤‡)</p>`;
                
                searchResults.forEach(result => {
                    html += `<div style="border-left: 3px solid #28a745; padding-left: 10px; margin: 10px 0;">`;
                    if (result.error) {
                        html += `<strong>${result.area}:</strong> <span style="color: red;">å¤±æ•— - ${result.error}</span><br>`;
                    } else {
                        html += `<strong>${result.area}:</strong> æ‰¾åˆ° ${result.count} å®¶é¤å»³ (æ–°å¢ ${result.newCount} å®¶ï¼Œé‡è¤‡ç‡ ${result.duplicateRate}%)<br>`;
                        html += `<small>ä½ç½®: ${result.location.lat.toFixed(4)}, ${result.location.lng.toFixed(4)}</small><br>`;
                        html += `<div class="restaurant-list">${result.restaurants.join(', ')}</div>`;
                    }
                    html += `</div>`;
                });
                
                resultDiv.innerHTML = html;
                
                console.log('ğŸ›£ï¸ è·¯åæœç´¢å®Œæˆï¼Œç¸½è¨ˆ:', allRestaurants.size, 'å®¶é¤å»³ï¼Œæ•´é«”é‡è¤‡ç‡:', overallDuplicateRate + '%');
                
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">âŒ æ¸¬è©¦å¤±æ•—: ${error.message}</p>`;
            }
        }

        // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
        window.onload = function() {
            console.log('ğŸš€ é¤å»³æœç´¢ç­–ç•¥æ¸¬è©¦é é¢å·²è¼‰å…¥ (æ–° API)');
            console.log('ğŸ“ æ¸¬è©¦ä½ç½®: å°å—è»Šç«™é™„è¿‘', testLocation);
            
            // æª¢æŸ¥ API é‡‘é‘°æ˜¯å¦å¯ç”¨
            if (typeof GOOGLE_PLACES_CONFIG === 'undefined' || !GOOGLE_PLACES_CONFIG.API_KEY) {
                console.error('âŒ Google Places API é‡‘é‘°æœªæ‰¾åˆ°ï¼Œè«‹æª¢æŸ¥ locationUtils.js');
                document.body.innerHTML += '<div style="background: #ffebee; border: 1px solid #f44336; padding: 15px; margin: 20px 0; border-radius: 4px;"><strong>éŒ¯èª¤:</strong> Google Places API é‡‘é‘°æœªæ‰¾åˆ°ï¼Œè«‹æª¢æŸ¥ locationUtils.js é…ç½®</div>';
            } else {
                console.log('âœ… API é‡‘é‘°å·²è¼‰å…¥:', GOOGLE_PLACES_CONFIG.API_KEY.substring(0, 10) + '...');
            }
        };
    </script>
</body>
</html>