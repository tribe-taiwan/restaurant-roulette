<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Places API getDetails 失敗原因測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        #results { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .stats { background: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>🧪 Google Places API getDetails 失敗原因測試</h1>
    
    <div class="stats">
        <h3>測試統計</h3>
        <div id="stats">等待測試開始...</div>
    </div>
    
    <button onclick="testGetDetailsFailure()">開始測試 getDetails 失敗原因</button>
    <button onclick="clearResults()">清除結果</button>
    
    <div id="results"></div>

    <script>
        // Google Maps API 載入
        window.initMap = function() {
            log('✅ Google Maps API 載入完成', 'success');
        };

        // 載入專案的配置
        const configScript = document.createElement('script');
        configScript.src = '../utils/locationUtils.js';
        document.head.appendChild(configScript);
        
        // 等待配置載入後再載入 Google Maps API
        configScript.onload = function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_PLACES_CONFIG?.API_KEY || '%%GOOGLE_PLACES_API_KEY%%'}&libraries=places&callback=initMap`;
            document.head.appendChild(script);
        };

        let placesService;
        let map;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // 自動滾動到底部
            const results = document.getElementById('results');
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').textContent = '等待測試開始...';
        }

        function updateStats(total, success, failed, errors) {
            const successRate = total > 0 ? ((success / total) * 100).toFixed(1) : 0;
            document.getElementById('stats').innerHTML = `
                <strong>總計:</strong> ${total} 家餐廳 | 
                <strong>成功:</strong> ${success} 家 (${successRate}%) | 
                <strong>失敗:</strong> ${failed} 家 | 
                <strong>錯誤類型:</strong> ${Object.keys(errors).length} 種
            `;
        }

        async function testGetDetailsFailure() {
            try {
                log('🚀 開始測試 Google Places API getDetails 失敗原因', 'info');
                
                // 初始化服務
                if (!placesService) {
                    const mapDiv = document.createElement('div');
                    map = new google.maps.Map(mapDiv);
                    placesService = new google.maps.places.PlacesService(map);
                    log('✅ Places Service 初始化完成', 'success');
                }

                // 先用 nearbySearch 獲取一些餐廳
                const userLocation = { lat: 25.033, lng: 121.5654 }; // 台北市
                log(`📍 搜尋位置: 台北市 (${userLocation.lat}, ${userLocation.lng})`, 'info');

                const request = {
                    location: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    radius: 1000,
                    type: 'restaurant'
                };

                const restaurants = await new Promise((resolve, reject) => {
                    placesService.nearbySearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            log(`✅ nearbySearch 成功: 找到 ${results.length} 家餐廳`, 'success');
                            resolve(results);
                        } else {
                            log(`❌ nearbySearch 失敗: ${status}`, 'error');
                            reject(new Error(status));
                        }
                    });
                });

                // 統計變數
                let totalRestaurants = Math.min(restaurants.length, 20); // 限制測試20家
                let successCount = 0;
                let failedCount = 0;
                let errorTypes = {};

                log(`🔍 開始測試前 ${totalRestaurants} 家餐廳的 getDetails 調用`, 'info');

                // 測試每家餐廳的 getDetails
                for (let i = 0; i < totalRestaurants; i++) {
                    const restaurant = restaurants[i];
                    log(`\n--- 測試餐廳 ${i + 1}/${totalRestaurants}: ${restaurant.name} ---`, 'info');
                    
                    try {
                        const details = await getPlaceDetails(restaurant.place_id);
                        
                        if (details) {
                            successCount++;
                            log(`✅ 成功獲取詳細資訊`, 'success');
                            log(`   - 有 opening_hours: ${!!details.opening_hours}`, 'info');
                            log(`   - 有 formatted_address: ${!!details.formatted_address}`, 'info');
                            log(`   - 有 business_status: ${details.business_status || 'N/A'}`, 'info');
                        } else {
                            failedCount++;
                            log(`❌ getDetails 返回 null`, 'error');
                            errorTypes['returned_null'] = (errorTypes['returned_null'] || 0) + 1;
                        }
                    } catch (error) {
                        failedCount++;
                        const errorType = error.message || 'unknown_error';
                        errorTypes[errorType] = (errorTypes[errorType] || 0) + 1;
                        log(`❌ getDetails 調用失敗: ${error.message}`, 'error');
                    }

                    updateStats(i + 1, successCount, failedCount, errorTypes);
                    
                    // 添加延遲避免API限制
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // 最終統計
                log('\n🏁 測試完成！最終統計:', 'info');
                log(`總計: ${totalRestaurants} 家餐廳`, 'info');
                log(`成功: ${successCount} 家 (${((successCount/totalRestaurants)*100).toFixed(1)}%)`, 'success');
                log(`失敗: ${failedCount} 家 (${((failedCount/totalRestaurants)*100).toFixed(1)}%)`, 'error');
                
                if (Object.keys(errorTypes).length > 0) {
                    log('\n🔍 錯誤類型分析:', 'warning');
                    for (const [errorType, count] of Object.entries(errorTypes)) {
                        log(`   ${errorType}: ${count} 次`, 'warning');
                    }
                }

                // 分析問題
                if (failedCount > successCount) {
                    log('\n⚠️ 發現嚴重問題: getDetails 失敗率過高！', 'error');
                    log('可能原因:', 'warning');
                    log('1. API 金鑰權限問題', 'warning');
                    log('2. API 配額不足', 'warning');
                    log('3. 餐廳資料已過期/不存在', 'warning');
                    log('4. 網路連線問題', 'warning');
                } else {
                    log('\n✅ getDetails 整體運作正常', 'success');
                }

            } catch (error) {
                log(`💥 測試過程發生錯誤: ${error.message}`, 'error');
            }
        }

        async function getPlaceDetails(placeId) {
            const request = {
                placeId: placeId,
                fields: ['name', 'formatted_address', 'opening_hours', 'business_status', 'place_id'],
                language: 'zh-TW'
            };

            return new Promise((resolve, reject) => {
                placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        resolve(place);
                    } else {
                        reject(new Error(`getDetails failed: ${status}`));
                    }
                });
            });
        }

        // 錯誤處理
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            log(`💥 JavaScript 錯誤: ${msg}`, 'error');
            return false;
        };
    </script>
</body>
</html>