<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Places API getDetails å¤±æ•—åŸå› æ¸¬è©¦</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        #results { margin-top: 20px; max-height: 400px; overflow-y: auto; }
        .stats { background: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 8px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Google Places API getDetails å¤±æ•—åŸå› æ¸¬è©¦</h1>
    
    <div class="stats">
        <h3>æ¸¬è©¦çµ±è¨ˆ</h3>
        <div id="stats">ç­‰å¾…æ¸¬è©¦é–‹å§‹...</div>
    </div>
    
    <button onclick="testGetDetailsFailure()">é–‹å§‹æ¸¬è©¦ getDetails å¤±æ•—åŸå› </button>
    <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
    
    <div id="results"></div>

    <script>
        // Google Maps API è¼‰å…¥
        window.initMap = function() {
            log('âœ… Google Maps API è¼‰å…¥å®Œæˆ', 'success');
        };

        // è¼‰å…¥å°ˆæ¡ˆçš„é…ç½®
        const configScript = document.createElement('script');
        configScript.src = '../utils/locationUtils.js';
        document.head.appendChild(configScript);
        
        // ç­‰å¾…é…ç½®è¼‰å…¥å¾Œå†è¼‰å…¥ Google Maps API
        configScript.onload = function() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_PLACES_CONFIG?.API_KEY || '%%GOOGLE_PLACES_API_KEY%%'}&libraries=places&callback=initMap`;
            document.head.appendChild(script);
        };

        let placesService;
        let map;
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // è‡ªå‹•æ»¾å‹•åˆ°åº•éƒ¨
            const results = document.getElementById('results');
            results.scrollTop = results.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').textContent = 'ç­‰å¾…æ¸¬è©¦é–‹å§‹...';
        }

        function updateStats(total, success, failed, errors) {
            const successRate = total > 0 ? ((success / total) * 100).toFixed(1) : 0;
            document.getElementById('stats').innerHTML = `
                <strong>ç¸½è¨ˆ:</strong> ${total} å®¶é¤å»³ | 
                <strong>æˆåŠŸ:</strong> ${success} å®¶ (${successRate}%) | 
                <strong>å¤±æ•—:</strong> ${failed} å®¶ | 
                <strong>éŒ¯èª¤é¡å‹:</strong> ${Object.keys(errors).length} ç¨®
            `;
        }

        async function testGetDetailsFailure() {
            try {
                log('ğŸš€ é–‹å§‹æ¸¬è©¦ Google Places API getDetails å¤±æ•—åŸå› ', 'info');
                
                // åˆå§‹åŒ–æœå‹™
                if (!placesService) {
                    const mapDiv = document.createElement('div');
                    map = new google.maps.Map(mapDiv);
                    placesService = new google.maps.places.PlacesService(map);
                    log('âœ… Places Service åˆå§‹åŒ–å®Œæˆ', 'success');
                }

                // å…ˆç”¨ nearbySearch ç²å–ä¸€äº›é¤å»³
                const userLocation = { lat: 25.033, lng: 121.5654 }; // å°åŒ—å¸‚
                log(`ğŸ“ æœå°‹ä½ç½®: å°åŒ—å¸‚ (${userLocation.lat}, ${userLocation.lng})`, 'info');

                const request = {
                    location: new google.maps.LatLng(userLocation.lat, userLocation.lng),
                    radius: 1000,
                    type: 'restaurant'
                };

                const restaurants = await new Promise((resolve, reject) => {
                    placesService.nearbySearch(request, (results, status) => {
                        if (status === google.maps.places.PlacesServiceStatus.OK) {
                            log(`âœ… nearbySearch æˆåŠŸ: æ‰¾åˆ° ${results.length} å®¶é¤å»³`, 'success');
                            resolve(results);
                        } else {
                            log(`âŒ nearbySearch å¤±æ•—: ${status}`, 'error');
                            reject(new Error(status));
                        }
                    });
                });

                // çµ±è¨ˆè®Šæ•¸
                let totalRestaurants = Math.min(restaurants.length, 20); // é™åˆ¶æ¸¬è©¦20å®¶
                let successCount = 0;
                let failedCount = 0;
                let errorTypes = {};

                log(`ğŸ” é–‹å§‹æ¸¬è©¦å‰ ${totalRestaurants} å®¶é¤å»³çš„ getDetails èª¿ç”¨`, 'info');

                // æ¸¬è©¦æ¯å®¶é¤å»³çš„ getDetails
                for (let i = 0; i < totalRestaurants; i++) {
                    const restaurant = restaurants[i];
                    log(`\n--- æ¸¬è©¦é¤å»³ ${i + 1}/${totalRestaurants}: ${restaurant.name} ---`, 'info');
                    
                    try {
                        const details = await getPlaceDetails(restaurant.place_id);
                        
                        if (details) {
                            successCount++;
                            log(`âœ… æˆåŠŸç²å–è©³ç´°è³‡è¨Š`, 'success');
                            log(`   - æœ‰ opening_hours: ${!!details.opening_hours}`, 'info');
                            log(`   - æœ‰ formatted_address: ${!!details.formatted_address}`, 'info');
                            log(`   - æœ‰ business_status: ${details.business_status || 'N/A'}`, 'info');
                        } else {
                            failedCount++;
                            log(`âŒ getDetails è¿”å› null`, 'error');
                            errorTypes['returned_null'] = (errorTypes['returned_null'] || 0) + 1;
                        }
                    } catch (error) {
                        failedCount++;
                        const errorType = error.message || 'unknown_error';
                        errorTypes[errorType] = (errorTypes[errorType] || 0) + 1;
                        log(`âŒ getDetails èª¿ç”¨å¤±æ•—: ${error.message}`, 'error');
                    }

                    updateStats(i + 1, successCount, failedCount, errorTypes);
                    
                    // æ·»åŠ å»¶é²é¿å…APIé™åˆ¶
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // æœ€çµ‚çµ±è¨ˆ
                log('\nğŸ æ¸¬è©¦å®Œæˆï¼æœ€çµ‚çµ±è¨ˆ:', 'info');
                log(`ç¸½è¨ˆ: ${totalRestaurants} å®¶é¤å»³`, 'info');
                log(`æˆåŠŸ: ${successCount} å®¶ (${((successCount/totalRestaurants)*100).toFixed(1)}%)`, 'success');
                log(`å¤±æ•—: ${failedCount} å®¶ (${((failedCount/totalRestaurants)*100).toFixed(1)}%)`, 'error');
                
                if (Object.keys(errorTypes).length > 0) {
                    log('\nğŸ” éŒ¯èª¤é¡å‹åˆ†æ:', 'warning');
                    for (const [errorType, count] of Object.entries(errorTypes)) {
                        log(`   ${errorType}: ${count} æ¬¡`, 'warning');
                    }
                }

                // åˆ†æå•é¡Œ
                if (failedCount > successCount) {
                    log('\nâš ï¸ ç™¼ç¾åš´é‡å•é¡Œ: getDetails å¤±æ•—ç‡éé«˜ï¼', 'error');
                    log('å¯èƒ½åŸå› :', 'warning');
                    log('1. API é‡‘é‘°æ¬Šé™å•é¡Œ', 'warning');
                    log('2. API é…é¡ä¸è¶³', 'warning');
                    log('3. é¤å»³è³‡æ–™å·²éæœŸ/ä¸å­˜åœ¨', 'warning');
                    log('4. ç¶²è·¯é€£ç·šå•é¡Œ', 'warning');
                } else {
                    log('\nâœ… getDetails æ•´é«”é‹ä½œæ­£å¸¸', 'success');
                }

            } catch (error) {
                log(`ğŸ’¥ æ¸¬è©¦éç¨‹ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        async function getPlaceDetails(placeId) {
            const request = {
                placeId: placeId,
                fields: ['name', 'formatted_address', 'opening_hours', 'business_status', 'place_id'],
                language: 'zh-TW'
            };

            return new Promise((resolve, reject) => {
                placesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        resolve(place);
                    } else {
                        reject(new Error(`getDetails failed: ${status}`));
                    }
                });
            });
        }

        // éŒ¯èª¤è™•ç†
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            log(`ğŸ’¥ JavaScript éŒ¯èª¤: ${msg}`, 'error');
            return false;
        };
    </script>
</body>
</html>