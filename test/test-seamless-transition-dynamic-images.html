<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€è™æ©Ÿç„¡ç¸«éŠœæ¥æ¸¬è©¦ - ä½¿ç”¨çœŸå¯¦åœ–ç‰‡</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f3f4f6;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .slot-container {
            height: 256px;
            width: 400px;
            margin: 20px auto;
            overflow: hidden;
            border: 3px solid #fbbf24;
            border-radius: 8px;
            position: relative;
            background: #f9fafb;
        }

        .slot-reel {
            display: flex;
            flex-direction: column;
        }

        .slot-item {
            height: 256px;
            width: 100%;
            flex-shrink: 0;
            position: relative;
        }

        .slot-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* åŸå§‹å‹•ç•«ï¼ˆæœ‰å•é¡Œï¼‰ */
        .animate-original-fast {
            animation: originalFast 0.5s linear infinite;
        }

        .animate-original-slow {
            animation: originalSlow 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes originalFast {
            0% { transform: translateY(0); }
            100% { transform: translateY(-1536px); /* 6å¼µåœ–ç‰‡ */ }
        }

        @keyframes originalSlow {
            0% { transform: translateY(0); }  /* å•é¡Œï¼šé‡æ–°å¾0é–‹å§‹ */
            70% { transform: translateY(-2000px); }
            100% { transform: translateY(-2304px); }
        }

        /* ä¿®å¾©å¾Œçš„å‹•ç•« */
        .animate-fixed-fast {
            animation: fixedFast 0.1s linear infinite;
        }

        .animate-fixed-slow {
            animation: fixedSlow 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        @keyframes fixedFast {
            0% { transform: translateY(0); }
            100% { transform: translateY(-256px); /* 1å¼µåœ–ç‰‡é«˜åº¦ */ }
        }

        /* å‹•æ…‹å‹•ç•« - ç”± JavaScript å‹•æ…‹ç”Ÿæˆ */
        .animate-fixed-slow-dynamic {
            animation: fixedSlowDynamic 2s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .test-section {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .test-section.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .btn.danger {
            background: #dc2626;
        }

        .btn.danger:hover {
            background: #b91c1c;
        }

        .btn.success {
            background: #059669;
        }

        .btn.success:hover {
            background: #047857;
        }

        .status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status.idle {
            background: #f3f4f6;
            color: #374151;
        }

        .status.spinning {
            background: #fef3c7;
            color: #92400e;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .restaurant-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .debug-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .slot-container {
                width: 100%;
                max-width: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #1f2937;">è€è™æ©Ÿç„¡ç¸«éŠœæ¥æ¸¬è©¦</h1>
        <p style="text-align: center; color: #6b7280;">ä½¿ç”¨çœŸå¯¦slotåœ–ç‰‡æ¸¬è©¦å‹•ç•«éŠœæ¥æ•ˆæœ</p>

        <!-- ğŸ¯ å‹•æ…‹é…ç½®é¡¯ç¤º -->
        <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 15px; margin: 20px 0; text-align: center;">
            <h4 style="margin: 0 0 10px 0; color: #0c4a6e;">ğŸ¯ å®Œå…¨è‡ªå‹•åŒ–é…ç½®ï¼ˆç„¡éœ€æ‰‹å‹•ä¿®æ”¹ä»»ä½•ä»£ç¢¼ï¼‰</h4>
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div><strong>åœ–ç‰‡æ•¸é‡:</strong> <span id="config-count">è‡ªå‹•åµæ¸¬ä¸­...</span></div>
                <div><strong>åµæ¸¬æ–¹å¼:</strong> è‡ªå‹•æƒæè³‡æ–™å¤¾</div>
                <div><strong>å‹•ç•«æ–¹å¼:</strong> æ¢å¾©åŸä¾†æœ€æ»¿æ„çš„æ•ˆæœ</div>
                <div><strong>ä½¿ç”¨æ–¹å¼:</strong> ç›´æ¥æ”¾åœ–ç‰‡åˆ°è³‡æ–™å¤¾å³å¯</div>
            </div>
        </div>

        <!-- å·¦å³ä½ˆå±€çš„æ¸¬è©¦å€åŸŸ -->
        <div style="display: flex; gap: 20px; margin: 20px 0; flex-wrap: wrap;">

            <!-- å·¦é‚Šï¼šä¿®å¾©ç‰ˆæœ¬æ¸¬è©¦ -->
            <div class="test-section" id="fixed-section" style="flex: 1; min-width: 350px;">
                <h3 style="color: #059669;">âœ… ä¿®å¾©ç‰ˆæœ¬ï¼ˆç„¡ç¸«éŠœæ¥ï¼‰</h3>
                <div class="slot-container">
                    <div class="slot-reel" id="fixed-reel">
                        <!-- åœ–ç‰‡å°‡ç”±JavaScriptå‹•æ…‹æ·»åŠ  -->
                    </div>
                    <div class="debug-info" id="fixed-debug">ç­‰å¾…æ¸¬è©¦</div>
                </div>
                <div class="status idle" id="fixed-status">ç‹€æ…‹: ç­‰å¾…æ¸¬è©¦</div>
                <button class="btn success" onclick="testFixed()" id="fixed-btn">æ¸¬è©¦ä¿®å¾©ç‰ˆæœ¬</button>

                <!-- æŠ€è¡“èªªæ˜ -->
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 10px; margin-top: 15px; font-size: 12px;">
                    <strong>ğŸ”§ æŠ€è¡“ç´°ç¯€ï¼š</strong><br>
                    â€¢ å‡½æ•¸ï¼š<code>testFixed()</code><br>
                    â€¢ å‹•ç•«ï¼š<code>createDynamicAnimation()</code><br>
                    â€¢ åµæ¸¬ï¼š<code>autoDetectSlotImages()</code><br>
                    â€¢ å¿«æ…¢è®ŠåŒ–ï¼š<code>cubic-bezier(0.25, 0.46, 0.45, 0.94)</code>
                </div>
            </div>

            <!-- å³é‚Šï¼šAPIæ¸¬è©¦ -->
            <div class="test-section" id="api-test-section" style="flex: 1; min-width: 350px;">
                <h3 style="color: #059669;">ğŸ” Google Places æ–°ç‰ˆAPIæ¸¬è©¦</h3>
                <div class="slot-container">
                    <div id="api-test-result" style="padding: 20px; text-align: center;">
                        <div id="api-status">æº–å‚™æ¸¬è©¦æ–°ç‰ˆAPI...</div>
                        <div id="api-image-container" style="margin-top: 10px;"></div>
                    </div>
                </div>
                <div class="status idle" id="api-test-status">ç‹€æ…‹: ç­‰å¾…æ¸¬è©¦</div>
                <button class="btn success" onclick="testNewPlacesAPI()" id="api-test-btn">æ¸¬è©¦æ–°ç‰ˆPlaces API</button>

                <!-- æŠ€è¡“èªªæ˜ -->
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 10px; margin-top: 15px; font-size: 12px;">
                    <strong>ğŸ”§ æŠ€è¡“ç´°ç¯€ï¼š</strong><br>
                    â€¢ å‡½æ•¸ï¼š<code>testNewPlacesAPI()</code><br>
                    â€¢ APIï¼š<code>Place.searchByText()</code><br>
                    â€¢ åœ–ç‰‡ï¼š<code>place.photos[0].getURI()</code>
                </div>
            </div>

        </div>

        <!-- è©³ç´°èªªæ˜ -->
        <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h4>ğŸ¯ æ¸¬è©¦é‡é»èˆ‡æŠ€è¡“ç´°ç¯€ï¼š</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">

                <!-- å·¦å´ï¼šä¿®å¾©ç‰ˆæœ¬èªªæ˜ -->
                <div>
                    <h5 style="color: #059669; margin: 0 0 10px 0;">âœ… ä¿®å¾©ç‰ˆæœ¬ï¼ˆç„¡ç¸«éŠœæ¥ï¼‰</h5>
                    <ul style="text-align: left; margin: 0; padding-left: 20px;">
                        <li><strong>è‡ªå‹•åµæ¸¬åœ–ç‰‡</strong>ï¼š<code>autoDetectSlotImages()</code></li>
                        <li><strong>å‹•æ…‹å‹•ç•«</strong>ï¼š<code>createDynamicAnimation()</code></li>
                        <li><strong>å¿«æ…¢è®ŠåŒ–</strong>ï¼š<code>cubic-bezier(0.25, 0.46, 0.45, 0.94)</code></li>
                        <li><strong>åºåˆ—é‚è¼¯</strong>ï¼šslotåœ–ç‰‡ + å‰2å¼µ + é¤å»³åœ–ç‰‡</li>
                        <li><strong>ç„¡ç¸«éŠœæ¥</strong>ï¼šé¤å»³åœ–ç‰‡ç”±ä¸‹è€Œä¸Šæ»¾å‡º</li>
                    </ul>
                </div>

                <!-- å³å´ï¼šAPIæ¸¬è©¦èªªæ˜ -->
                <div>
                    <h5 style="color: #059669; margin: 0 0 10px 0;">ğŸ” Google Places æ–°ç‰ˆAPIæ¸¬è©¦</h5>
                    <ul style="text-align: left; margin: 0; padding-left: 20px;">
                        <li><strong>APIå‡½æ•¸</strong>ï¼š<code>testNewPlacesAPI()</code></li>
                        <li><strong>æœå°‹æ–¹æ³•</strong>ï¼š<code>Place.searchByText()</code></li>
                        <li><strong>åœ–ç‰‡å–å¾—</strong>ï¼š<code>place.photos[0].getURI()</code></li>
                        <li><strong>æ¸¬è©¦ç›®çš„</strong>ï¼šé©—è­‰æ–°ç‰ˆPlaces APIåŠŸèƒ½</li>
                        <li><strong>åœ–ç‰‡ä¾†æº</strong>ï¼šGoogle MapsçœŸå¯¦é¤å»³ç…§ç‰‡</li>
                    </ul>
                </div>

            </div>

            <!-- æ ¸å¿ƒè®Šæ•¸èˆ‡å‡½æ•¸ -->
            <div style="background: #fff; border: 2px solid #e5e7eb; border-radius: 6px; padding: 15px; margin-top: 20px;">
                <h5 style="margin: 0 0 10px 0; color: #374151;">ğŸ”§ æ ¸å¿ƒè®Šæ•¸èˆ‡å‡½æ•¸ï¼ˆå¯è¤‡è£½æœå°‹ï¼‰ï¼š</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-family: monospace; font-size: 12px;">
                    <div><strong>åœ–ç‰‡åµæ¸¬ï¼š</strong><code>autoDetectSlotImages</code></div>
                    <div><strong>å‹•ç•«ç”Ÿæˆï¼š</strong><code>createDynamicAnimation</code></div>
                    <div><strong>ä¿®å¾©æ¸¬è©¦ï¼š</strong><code>testFixed</code></div>
                    <div><strong>APIæ¸¬è©¦ï¼š</strong><code>testNewPlacesAPI</code></div>
                    <div><strong>åœ–ç‰‡é™£åˆ—ï¼š</strong><code>slotImages</code></div>
                    <div><strong>åœ–ç‰‡æ•¸é‡ï¼š</strong><code>SLOT_IMAGE_COUNT</code></div>
                    <div><strong>å‹•ç•«é¡åˆ¥ï¼š</strong><code>animate-fixed-slow-dynamic</code></div>
                    <div><strong>å¿«æ…¢æ›²ç·šï¼š</strong><code>cubic-bezier(0.25, 0.46, 0.45, 0.94)</code></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥APIé…ç½® -->
    <script src="../utils/locationUtils.js"></script>
    <!-- ç›´æ¥è¼‰å…¥æœ¬åœ°API Keyï¼ˆä¿®å¾©è·¯å¾‘å•é¡Œï¼‰ -->
    <script>
        // ç›´æ¥å¾æ­£ç¢ºè·¯å¾‘è¼‰å…¥API Key
        fetch('../_local/.api_key')
            .then(response => response.text())
            .then(apiKey => {
                if (window.GOOGLE_PLACES_CONFIG) {
                    window.GOOGLE_PLACES_CONFIG.API_KEY = apiKey.trim();
                    console.log('âœ… æ¸¬è©¦é é¢ï¼šæœ¬åœ° API Key å·²è¼‰å…¥');
                }
            })
            .catch(error => {
                console.error('âŒ æ¸¬è©¦é é¢ï¼šç„¡æ³•è®€å– .api_key æª”æ¡ˆ:', error);
            });
    </script>

    <script>
        // ğŸ¯ è‡ªå‹•åµæ¸¬åœ–ç‰‡æ•¸é‡ - å®Œå…¨ä¸éœ€è¦æ‰‹å‹•ä¿®æ”¹ä»»ä½•æ•¸å­—ï¼
        let SLOT_IMAGE_COUNT = 6; // é è¨­å€¼ï¼Œæœƒè¢«è‡ªå‹•åµæ¸¬è¦†è“‹
        let slotImages = [];

        // è‡ªå‹•åµæ¸¬å¯ç”¨çš„slotåœ–ç‰‡æ•¸é‡
        async function autoDetectSlotImages() {
            const basePath = '../assets/image/slot-machine';
            const detectedImages = [];
            let maxTries = 20; // æœ€å¤šå˜—è©¦20å¼µåœ–ç‰‡

            console.log('ğŸ” é–‹å§‹è‡ªå‹•åµæ¸¬slotåœ–ç‰‡æ•¸é‡...');

            for (let i = 1; i <= maxTries; i++) {
                const imagePath = `${basePath}/slot (${i}).jpg`;

                try {
                    // å˜—è©¦è¼‰å…¥åœ–ç‰‡
                    const response = await fetch(imagePath, { method: 'HEAD' });
                    if (response.ok) {
                        detectedImages.push(imagePath);
                        console.log(`âœ… æ‰¾åˆ°åœ–ç‰‡ ${i}: ${imagePath}`);
                    } else {
                        console.log(`âŒ åœ–ç‰‡ ${i} ä¸å­˜åœ¨ï¼Œåœæ­¢åµæ¸¬`);
                        break;
                    }
                } catch (error) {
                    console.log(`âŒ åœ–ç‰‡ ${i} è¼‰å…¥å¤±æ•—ï¼Œåœæ­¢åµæ¸¬`);
                    break;
                }
            }

            SLOT_IMAGE_COUNT = detectedImages.length;
            console.log(`ğŸ¯ è‡ªå‹•åµæ¸¬å®Œæˆï¼æ‰¾åˆ° ${SLOT_IMAGE_COUNT} å¼µslotåœ–ç‰‡`);

            return detectedImages;
        }

        // ğŸ¯ å‹•æ…‹ç”ŸæˆCSSå‹•ç•« - æ¢å¾©åŸä¾†æœ€æ»¿æ„çš„æ•ˆæœ
        function createDynamicAnimation(imageCount) {
            const itemHeight = 256; // æ¯å¼µåœ–ç‰‡é«˜åº¦

            // ğŸ¯ ä½¿ç”¨åŸä¾†çš„é‚è¼¯ï¼šslotåœ–ç‰‡ + å‰2å¼µ + é¤å»³åœ–ç‰‡
            // åŸä¾†6å¼µåœ–ç‰‡çš„è¨ˆç®—ï¼š6 + 2 + 1 = 9å¼µï¼Œåœåœ¨ç¬¬9å¼µï¼ˆ2304px = 9 * 256ï¼‰
            const totalImages = imageCount + 2 + 1;
            const finalPosition = (totalImages - 1) * itemHeight; // åœåœ¨æœ€å¾Œä¸€å¼µï¼ˆé¤å»³åœ–ç‰‡ï¼‰

            // åŸä¾†çš„70%ä½ç½®è¨ˆç®—æ–¹å¼
            const midPosition = Math.floor((totalImages - 3) * itemHeight); // å¤§ç´„åœ¨å€’æ•¸ç¬¬3å¼µçš„ä½ç½®

            console.log(`ğŸ° æ¢å¾©åŸæ•ˆæœè¨ˆç®—: ${imageCount}å¼µslotåœ–ç‰‡ + 2å¼µ + 1å¼µé¤å»³ = ${totalImages}å¼µç¸½è¨ˆ`);
            console.log(`ğŸ° 70%ä½ç½®: ${midPosition}px, æœ€çµ‚ä½ç½®: ${finalPosition}px`);

            // å‹•æ…‹å‰µå»ºCSS keyframes - ä¿æŒåŸä¾†çš„å¿«æ…¢è®ŠåŒ–
            const keyframes = `
                @keyframes fixedSlowDynamic {
                    0% { transform: translateY(0); }
                    70% { transform: translateY(-${midPosition}px); }
                    100% { transform: translateY(-${finalPosition}px); }
                }
            `;

            // ç§»é™¤èˆŠçš„å‹•ç•«æ¨£å¼
            const oldStyle = document.getElementById('dynamic-animation');
            if (oldStyle) {
                oldStyle.remove();
            }

            // æ·»åŠ æ–°çš„å‹•ç•«æ¨£å¼
            const style = document.createElement('style');
            style.id = 'dynamic-animation';
            style.textContent = keyframes;
            document.head.appendChild(style);

            console.log('ğŸ¨ åŸæ•ˆæœå‹•æ…‹CSSå‹•ç•«å·²ç”Ÿæˆ');
        }

        // APIè¿”å›çš„é¤å»³åœ–ç‰‡
        let restaurantImage = null;
        let testPlacesService = null;

        // ä½¿ç”¨çœŸå¯¦APIç²å–é¤å»³åœ–ç‰‡
        async function getRestaurantImage() {
            if (restaurantImage) return restaurantImage; // å·²ç²å–é

            console.log('ğŸ” é–‹å§‹ç²å–çœŸå¯¦é¤å»³åœ–ç‰‡...');

            try {
                // ç­‰å¾…API Keyè¼‰å…¥å®Œæˆ
                let attempts = 0;
                while (attempts < 20) {
                    if (window.GOOGLE_PLACES_CONFIG &&
                        window.GOOGLE_PLACES_CONFIG.API_KEY &&
                        !window.GOOGLE_PLACES_CONFIG.API_KEY.includes('%%')) {
                        console.log('âœ… æª¢æ¸¬åˆ°æœ¬åœ°API Keyå·²è¼‰å…¥');
                        break;
                    }
                    console.log(`â³ ç­‰å¾…API Keyè¼‰å…¥... (${attempts + 1}/20)`);
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }

                if (!window.GOOGLE_PLACES_CONFIG ||
                    !window.GOOGLE_PLACES_CONFIG.API_KEY ||
                    window.GOOGLE_PLACES_CONFIG.API_KEY.includes('%%')) {
                    throw new Error('API Keyè¼‰å…¥è¶…æ™‚');
                }

                // ä½¿ç”¨çœŸå¯¦API Keyåˆå§‹åŒ–Google Maps
                console.log('ğŸ“¡ ä½¿ç”¨çœŸå¯¦API Keyåˆå§‹åŒ–Google Maps...');

                if (!testPlacesService) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_PLACES_CONFIG.API_KEY}&libraries=places&callback=initRealAPI`;
                        script.async = true;

                        window.initRealAPI = () => {
                            try {
                                console.log('ğŸ—ºï¸ å‰µå»ºåœ°åœ–æœå‹™...');
                                const mapDiv = document.createElement('div');
                                mapDiv.style.display = 'none';
                                document.body.appendChild(mapDiv);

                                const testMap = new google.maps.Map(mapDiv, {
                                    center: { lat: 22.9908, lng: 120.2133 },
                                    zoom: 15
                                });

                                testPlacesService = new google.maps.places.PlacesService(testMap);
                                console.log('âœ… Google Maps APIåˆå§‹åŒ–å®Œæˆ');
                                resolve();
                            } catch (error) {
                                reject(error);
                            }
                        };

                        script.onerror = () => reject(new Error('Google Maps APIè¼‰å…¥å¤±æ•—'));
                        document.head.appendChild(script);
                    });
                }

                console.log('ğŸ” æœç´¢å°å—é™„è¿‘é¤å»³...');

                // æœç´¢é¤å»³ä¸¦ç²å–åœ–ç‰‡
                return new Promise((resolve) => {
                    const request = {
                        location: { lat: 22.9908, lng: 120.2133 },
                        radius: 1000,
                        type: 'restaurant'
                    };

                    testPlacesService.nearbySearch(request, (results, status) => {
                        console.log('ğŸ“Š æœç´¢çµæœ:', status, results ? results.length : 0);

                        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
                            for (let restaurant of results) {
                                if (restaurant.photos && restaurant.photos.length > 0) {
                                    restaurantImage = restaurant.photos[0].getUrl({ maxWidth: 400 });
                                    console.log('âœ… ç²å–çœŸå¯¦é¤å»³åœ–ç‰‡:', restaurant.name, restaurantImage);
                                    resolve(restaurantImage);
                                    return;
                                }
                            }
                        }

                        console.log('âš ï¸ æœªæ‰¾åˆ°æœ‰ç…§ç‰‡çš„é¤å»³ï¼Œä½¿ç”¨ç´…è‰²å‚™ç”¨');
                        restaurantImage = 'fallback-red';
                        resolve(restaurantImage);
                    });
                });

            } catch (error) {
                console.error('âŒ APIéŒ¯èª¤:', error);
                restaurantImage = 'fallback-red';
                return restaurantImage;
            }
        }

        let currentTest = null;

        function createSlotItems(images, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            images.forEach((src, index) => {
                const item = document.createElement('div');
                item.className = 'slot-item';
                
                const img = document.createElement('img');
                img.src = src;
                img.alt = `slot-${index}`;
                img.onerror = function() {
                    // å¦‚æœæ˜¯é¤å»³åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼Œé¡¯ç¤ºç´…è‰²èƒŒæ™¯
                    if (src === restaurantImage || src === 'fallback-red' || (src && (src.includes('googleusercontent.com') || src.includes('unsplash.com')))) {
                        this.style.background = '#dc2626';
                        this.style.display = 'flex';
                        this.style.alignItems = 'center';
                        this.style.justifyContent = 'center';
                        this.innerHTML = `<span style="color: white; font-size: 24px;">ğŸ½ï¸ é¤å»³åœ–ç‰‡</span>`;
                    } else {
                        this.style.background = '#e5e7eb';
                        this.style.display = 'flex';
                        this.style.alignItems = 'center';
                        this.style.justifyContent = 'center';
                        this.innerHTML = `<span style="color: #6b7280;">åœ–ç‰‡ ${index + 1}</span>`;
                    }
                };

                // å¦‚æœæ˜¯ç´…è‰²å‚™ç”¨ï¼Œç›´æ¥è§¸ç™¼éŒ¯èª¤è™•ç†é¡¯ç¤ºç´…è‰²èƒŒæ™¯
                if (src === 'fallback-red') {
                    img.onerror();
                }
                
                item.appendChild(img);
                
                // å¦‚æœæ˜¯é¤å»³åœ–ç‰‡ï¼Œæ·»åŠ è¦†è“‹å±¤
                if (src === restaurantImage || src === 'fallback-red' || (src && src.includes('googleusercontent.com'))) {
                    const overlay = document.createElement('div');
                    overlay.className = 'restaurant-overlay';
                    overlay.textContent = 'ğŸ‰ æ‰¾åˆ°é¤å»³ï¼';
                    item.appendChild(overlay);
                }
                
                container.appendChild(item);
            });
        }

        function updateStatus(type, status, message) {
            const statusEl = document.getElementById(`${type}-status`);
            const debugEl = document.getElementById(`${type}-debug`);
            
            statusEl.className = `status ${status}`;
            statusEl.textContent = `ç‹€æ…‹: ${message}`;
            debugEl.textContent = message;
        }

        // æ¸¬è©¦æ–°ç‰ˆGoogle Places API
        async function testNewPlacesAPI() {
            if (currentTest) return;
            currentTest = 'api-test';

            const section = document.getElementById('api-test-section');
            section.classList.add('active');

            const statusDiv = document.getElementById('api-status');
            const imageContainer = document.getElementById('api-image-container');
            const testBtn = document.getElementById('api-test-btn');

            testBtn.disabled = true;
            statusDiv.textContent = 'åˆå§‹åŒ–æ–°ç‰ˆPlaces API...';
            imageContainer.innerHTML = '';

            try {
                // ç­‰å¾…API Keyè¼‰å…¥
                let attempts = 0;
                while (attempts < 20) {
                    if (window.GOOGLE_PLACES_CONFIG &&
                        window.GOOGLE_PLACES_CONFIG.API_KEY &&
                        !window.GOOGLE_PLACES_CONFIG.API_KEY.includes('%%')) {
                        break;
                    }
                    statusDiv.textContent = `ç­‰å¾…API Keyè¼‰å…¥... (${attempts + 1}/20)`;
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }

                if (!window.GOOGLE_PLACES_CONFIG ||
                    !window.GOOGLE_PLACES_CONFIG.API_KEY ||
                    window.GOOGLE_PLACES_CONFIG.API_KEY.includes('%%')) {
                    throw new Error('API Keyè¼‰å…¥å¤±æ•—');
                }

                statusDiv.textContent = 'è¼‰å…¥Google Maps API...';

                // è¼‰å…¥Google Maps APIï¼ˆæ¸¬è©¦é é¢ç¨ç«‹è¼‰å…¥ï¼‰
                if (!window.google || !window.google.maps) {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = `https://maps.googleapis.com/maps/api/js?key=${window.GOOGLE_PLACES_CONFIG.API_KEY}&libraries=places&callback=initTestAPI`;
                        script.async = true;

                        window.initTestAPI = () => {
                            statusDiv.textContent = 'âœ… Google Maps APIè¼‰å…¥å®Œæˆ';
                            resolve();
                        };

                        script.onerror = () => reject(new Error('Google Maps APIè¼‰å…¥å¤±æ•—'));
                        document.head.appendChild(script);
                    });
                }

                statusDiv.textContent = 'æœç´¢å°å—é™„è¿‘é¤å»³...';

                // ä½¿ç”¨æ–°ç‰ˆPlaces APIæœç´¢é¤å»³
                const { Place } = await google.maps.importLibrary("places");

                const request = {
                    textQuery: 'restaurant in Tainan',
                    fields: ['displayName', 'photos', 'location'],
                    locationBias: { lat: 22.9908, lng: 120.2133 },
                    maxResultCount: 10
                };

                const { places } = await Place.searchByText(request);

                if (places && places.length > 0) {
                    // æ‰¾ç¬¬ä¸€å€‹æœ‰ç…§ç‰‡çš„é¤å»³
                    for (let place of places) {
                        if (place.photos && place.photos.length > 0) {
                            const photoUrl = place.photos[0].getURI({ maxWidth: 400 });

                            statusDiv.textContent = `âœ… æ‰¾åˆ°é¤å»³: ${place.displayName}`;

                            const img = document.createElement('img');
                            img.src = photoUrl;
                            img.style.maxWidth = '100%';
                            img.style.borderRadius = '8px';
                            img.onload = () => {
                                statusDiv.textContent = `âœ… æˆåŠŸè¼‰å…¥é¤å»³åœ–ç‰‡: ${place.displayName}`;
                            };
                            img.onerror = () => {
                                statusDiv.textContent = `âŒ åœ–ç‰‡è¼‰å…¥å¤±æ•—: ${place.displayName}`;
                            };

                            imageContainer.appendChild(img);

                            // è¨­ç½®ç‚ºé¤å»³åœ–ç‰‡ä¾›è€è™æ©Ÿä½¿ç”¨
                            restaurantImage = photoUrl;
                            console.log('âœ… æ–°ç‰ˆAPIç²å–é¤å»³åœ–ç‰‡:', place.displayName, photoUrl);
                            break;
                        }
                    }
                } else {
                    throw new Error('æœªæ‰¾åˆ°é¤å»³');
                }

            } catch (error) {
                console.error('âŒ æ–°ç‰ˆAPIæ¸¬è©¦å¤±æ•—:', error);
                statusDiv.textContent = `âŒ æ¸¬è©¦å¤±æ•—: ${error.message}`;
                imageContainer.innerHTML = '<div style="color: red;">æ¸¬è©¦å¤±æ•—</div>';
            } finally {
                section.classList.remove('active');
                testBtn.disabled = false;
                currentTest = null;
            }
        }

        async function testFixed() {
            if (currentTest) return;
            currentTest = 'fixed';

            const section = document.getElementById('fixed-section');
            section.classList.add('active');

            updateStatus('fixed', 'spinning', 'é–‹å§‹ä¿®å¾©æ¸¬è©¦...');
            document.getElementById('fixed-btn').disabled = true;

            // å…ˆè¨­ç½®å¿«é€Ÿå¾ªç’°åºåˆ—
            const fastImages = [];
            for (let i = 0; i < 20; i++) {
                fastImages.push(...slotImages);
            }

            createSlotItems(fastImages, 'fixed-reel');

            const reel = document.getElementById('fixed-reel');
            reel.className = 'slot-reel animate-fixed-fast';

            // æ¨¡æ“¬APIè¿”å›
            setTimeout(async () => {
                updateStatus('fixed', 'spinning', 'ç²å–é¤å»³åœ–ç‰‡...');
                const apiImage = await getRestaurantImage();

                updateStatus('fixed', 'spinning', 'APIè¿”å›ï¼Œé‡å»ºåºåˆ—...');

                // ğŸ¯ å‹•æ…‹æ§‹å»ºåºåˆ— - è‡ªå‹•é©æ‡‰åœ–ç‰‡æ•¸é‡
                const finalSequence = [
                    ...slotImages,                    // æ‰€æœ‰ slot åœ–ç‰‡
                    ...slotImages.slice(0, 2),       // å†åŠ å‰2å¼µç¢ºä¿è¶³å¤ æ»¾å‹•
                    apiImage                         // é¤å»³åœ–ç‰‡ï¼ˆæœ€å¾Œä¸€å¼µï¼‰
                ];

                console.log(`ğŸ° æœ€çµ‚åºåˆ—: ${finalSequence.length} å¼µåœ–ç‰‡`);
                console.log('ğŸ° æœ€å¾Œä¸€å¼µæ˜¯é¤å»³åœ–ç‰‡:', apiImage);

                // ğŸ¯ å‹•æ…‹ç”ŸæˆCSSå‹•ç•« - ä¿æŒåŸæœ‰çš„å¿«æ…¢æ•ˆæœ
                createDynamicAnimation(slotImages.length);

                createSlotItems(finalSequence, 'fixed-reel');

                // ğŸ¯ ä½¿ç”¨å‹•æ…‹ç”Ÿæˆçš„CSSå‹•ç•« - ä¿æŒåŸæœ‰çš„æµæš¢æ•ˆæœ
                setTimeout(() => {
                    const newReel = document.getElementById('fixed-reel');
                    newReel.classList.remove('animate-fixed-fast');
                    newReel.classList.add('animate-fixed-slow-dynamic');

                    newReel.addEventListener('animationend', () => {
                        updateStatus('fixed', 'success', 'å®Œæˆï¼ˆç„¡ç¸«éŠœæ¥ï¼‰');
                        section.classList.remove('active');
                        document.getElementById('fixed-btn').disabled = false;
                        currentTest = null;
                    }, { once: true });
                }, 50);
            }, 2000);
        }



        // é é¢è¼‰å…¥å®Œæˆå¾Œçš„åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            console.log('ğŸ¯ æ¸¬è©¦é é¢è¼‰å…¥å®Œæˆ');

            // ğŸ¯ è‡ªå‹•åµæ¸¬åœ–ç‰‡æ•¸é‡
            slotImages = await autoDetectSlotImages();

            console.log('ğŸ¯ è‡ªå‹•åµæ¸¬çµæœ - åœ–ç‰‡æ•¸é‡:', SLOT_IMAGE_COUNT);
            console.log('ğŸ“¸ Slotåœ–ç‰‡è·¯å¾‘:', slotImages);
            console.log('GOOGLE_PLACES_CONFIG:', window.GOOGLE_PLACES_CONFIG);

            // æ›´æ–°é…ç½®é¡¯ç¤º
            document.getElementById('config-count').textContent = SLOT_IMAGE_COUNT;

            // ğŸ¯ æ ¹æ“šåµæ¸¬çµæœç”Ÿæˆå‹•æ…‹CSSå‹•ç•«
            createDynamicAnimation(SLOT_IMAGE_COUNT);

            // æª¢æŸ¥APIé…ç½®
            if (window.GOOGLE_PLACES_CONFIG) {
                console.log('API Keyç‹€æ…‹:', window.GOOGLE_PLACES_CONFIG.API_KEY.substring(0, 20) + '...');
            } else {
                console.error('âŒ locationUtils.js æœªæ­£ç¢ºè¼‰å…¥');
            }
        });
    </script>
</body>
</html>
