<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®å¾©çš„æ»¾å‹•å¸é™„æ¸¬è©¦</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        .section {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
        }
        
        .section-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .slot-machine {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: 5px solid white;
            border-radius: 20px;
            position: relative;
        }
        
        .section-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 11px;
            z-index: 1000;
            font-family: monospace;
            max-width: 350px;
            line-height: 1.4;
        }
        
        .copy-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            z-index: 1001;
        }
        
        .copy-btn:hover {
            background: #45a049;
        }
        
        .copy-btn:active {
            background: #3d8b40;
        }
    </style>
</head>
<body>
    <button class="copy-btn" onclick="copyTechInfo()">ğŸ“‹ è¤‡è£½æŠ€è¡“è³‡è¨Š</button>
    
    <div class="debug-info" id="debug">
        <div><strong>ğŸ”§ ä¿®å¾©çš„æ»¾å‹•å¸é™„æ¸¬è©¦</strong></div>
        <div>ç‹€æ…‹: <span id="status">ç­‰å¾…æ»‘å‹•...</span></div>
        <div>ä½ç½®: <span id="position">-</span></div>
        <div>æœ€å¾Œäº‹ä»¶: <span id="last-event">ç„¡</span></div>
        <div>è§¸ç™¼æ¬¡æ•¸: <span id="trigger-count">0</span></div>
        <div>å¹³å‡ç²¾åº¦: <span id="avg-accuracy">-</span></div>
        <div>æœ€å¾Œç²¾åº¦: <span id="last-accuracy">-</span></div>
    </div>
    
    <div class="section section-1">
        <div>
            ä¸Šæ–¹å€åŸŸ<br>
            å¿«é€Ÿå‘ä¸‹æ»‘å‹•æ¸¬è©¦<br>
            <small>âœ… æ‡‰è©²å¸é™„åˆ°è€è™æ©Ÿ</small>
        </div>
    </div>
    
    <div class="section slot-machine" data-name="slot-machine">
        <div>
            ğŸ° è€è™æ©Ÿå€å¡Š<br>
            ç›®æ¨™å®šä½é»<br>
            <small style="color: #ffeb3b;">âŒ åœ¨æ­¤å€åŸŸå…§æ»‘å‹•ä¸æ‡‰è©²è§¸ç™¼å¸é™„</small>
        </div>
    </div>
    
    <div class="section section-3">
        <div>
            ä¸‹æ–¹å€åŸŸ<br>
            å¿«é€Ÿå‘ä¸Šæ»‘å‹•æ¸¬è©¦<br>
            <small>âœ… æ‡‰è©²å¸é™„åˆ°è€è™æ©Ÿ</small><br>
            <small style="color: #ff6b6b;">âŒ å‘ä¸‹æ»‘å‹•ä¸æ‡‰è©²è§¸ç™¼</small>
        </div>
    </div>

    <script>
        // ä¿®å¾©ç‰ˆæœ¬ - åŸºæ–¼æœ‰æ•ˆçš„æœ€å°ç‰ˆæœ¬ï¼Œæ·»åŠ æ­£ç¢ºçš„è§¸ç™¼é‚è¼¯
        class FixedScrollSnap {
            constructor() {
                this.startY = null;
                this.startTime = null;
                this.isTracking = false;
                this.VELOCITY_THRESHOLD = 0.8;
                this.MIN_DISTANCE = 50;
                this.triggerCount = 0;
                this.accuracyHistory = [];
                this.techInfo = [];
                
                this.bindEvents();
                this.log('ä¿®å¾©ç‰ˆæœ¬åˆå§‹åŒ–å®Œæˆ');
                this.updatePosition();
            }
            
            bindEvents() {
                // è§¸æ§äº‹ä»¶
                document.addEventListener('touchstart', (e) => this.onStart(e.touches[0].clientY), { passive: false });
                document.addEventListener('touchend', (e) => this.onEnd(e.changedTouches[0].clientY, e), { passive: false });
                
                // æ»‘é¼ äº‹ä»¶ (ç”¨æ–¼æ¸¬è©¦)
                document.addEventListener('mousedown', (e) => this.onStart(e.clientY), { passive: false });
                document.addEventListener('mouseup', (e) => this.onEnd(e.clientY, e), { passive: false });
            }
            
            onStart(y) {
                this.startY = y;
                this.startTime = Date.now();
                this.isTracking = true;
                
                // è¨˜éŒ„é–‹å§‹æ™‚çš„ä½ç½®ï¼Œé¿å…æ»¾å‹•éç¨‹ä¸­ä½ç½®æ”¹è®Š
                this.startPosition = this.getRelativePosition();
                this.log(`é–‹å§‹: Y=${Math.round(this.startY)}, ä½ç½®=${this.startPosition}`);
                this.updatePosition();
            }
            
            onEnd(y, event) {
                if (!this.isTracking) return;
                
                const endY = y;
                const endTime = Date.now();
                
                const distance = Math.abs(endY - this.startY);
                const duration = endTime - this.startTime;
                const velocity = distance / duration;
                
                // ä¿®æ­£æ–¹å‘æª¢æ¸¬é‚è¼¯ï¼š
                // æ‰‹æŒ‡å‘ä¸Šæ»‘å‹• (endY < startY) = é é¢å‘ä¸‹æ»¾å‹• = down
                // æ‰‹æŒ‡å‘ä¸‹æ»‘å‹• (endY > startY) = é é¢å‘ä¸Šæ»¾å‹• = up  
                const direction = endY < this.startY ? 'down' : 'up';
                
                // ä½¿ç”¨é–‹å§‹æ™‚çš„ä½ç½®ï¼Œé¿å…æ»¾å‹•éç¨‹ä¸­ä½ç½®æ”¹è®Šå½±éŸ¿åˆ¤æ–·
                const position = this.startPosition || this.getRelativePosition();
                
                // è©³ç´°çš„æ–¹å‘åˆ†æ
                const fingerDirection = endY < this.startY ? 'å‘ä¸Š' : 'å‘ä¸‹';
                const pageDirection = endY < this.startY ? 'å‘ä¸‹' : 'å‘ä¸Š';
                
                this.log(`æ»‘å‹•: è·é›¢=${distance}px, é€Ÿåº¦=${velocity.toFixed(3)}px/ms`);
                this.log(`æ‰‹æŒ‡${fingerDirection}æ»‘å‹• â†’ é é¢${pageDirection}æ»¾å‹• (${direction}), é–‹å§‹ä½ç½®=${position}`);
                
                // æª¢æŸ¥åŸºæœ¬æ¢ä»¶
                const isFastEnough = velocity > this.VELOCITY_THRESHOLD;
                const isLongEnough = distance > this.MIN_DISTANCE;
                
                // æª¢æŸ¥æ­£ç¢ºçš„è§¸ç™¼æ¢ä»¶ (æ ¹æ“šéœ€æ±‚)
                const shouldTriggerSnap = this.shouldTriggerSnap(direction, position);
                const shouldTrigger = isFastEnough && isLongEnough && shouldTriggerSnap;
                
                // ç«‹å³é˜»æ­¢åŸç”Ÿæ»¾å‹•ï¼ˆå¦‚æœéœ€è¦è§¸ç™¼å¸é™„ï¼‰
                if (shouldTrigger) {
                    this.log(`ğŸš« ç«‹å³é˜»æ­¢åŸç”Ÿæ»¾å‹•`);
                    event.preventDefault();
                    event.stopPropagation();
                }
                
                if (shouldTrigger) {
                    this.triggerCount++;
                    this.log(`âœ… è§¸ç™¼å¸é™„ (#${this.triggerCount})`);
                    
                    // ç«‹å³åŸ·è¡Œå¸é™„ï¼Œä¸å»¶é²
                    this.snapToTarget();
                } else {
                    const reasons = [];
                    if (!isFastEnough) reasons.push(`é€Ÿåº¦ä¸è¶³(${velocity.toFixed(3)})`);
                    if (!isLongEnough) reasons.push(`è·é›¢ä¸è¶³(${distance}px)`);
                    if (!shouldTriggerSnap) reasons.push(`æ–¹å‘éŒ¯èª¤(${direction}åœ¨${position})`);
                    
                    this.log(`ğŸ”„ ä¿æŒåŸç”Ÿæ»¾å‹•: ${reasons.join(', ')}`);
                }
                
                this.isTracking = false;
                document.getElementById('trigger-count').textContent = this.triggerCount;
            }
            
            // æ ¹æ“šéœ€æ±‚æ–‡ä»¶çš„æ­£ç¢ºè§¸ç™¼é‚è¼¯
            shouldTriggerSnap(direction, position) {
                // éœ€æ±‚ 1: åœ¨è€è™æ©Ÿä¸Šæ–¹å¿«é€Ÿå‘ä¸‹æ»¾å‹•æ™‚å¸é™„
                // æ‰‹æŒ‡å‘ä¸Šæ»‘å‹• â†’ é é¢å‘ä¸‹æ»¾å‹• â†’ direction = 'down'
                if (position === 'above' && direction === 'down') {
                    console.log('âœ… ç¬¦åˆéœ€æ±‚1: ä¸Šæ–¹å€åŸŸï¼Œé é¢å‘ä¸‹æ»¾å‹•');
                    return true;
                }
                
                // éœ€æ±‚ 2: åœ¨è€è™æ©Ÿä¸‹æ–¹å¿«é€Ÿå‘ä¸Šæ»¾å‹•æ™‚å¸é™„
                // æ‰‹æŒ‡å‘ä¸‹æ»‘å‹• â†’ é é¢å‘ä¸Šæ»¾å‹• â†’ direction = 'up'  
                if (position === 'below' && direction === 'up') {
                    console.log('âœ… ç¬¦åˆéœ€æ±‚2: ä¸‹æ–¹å€åŸŸï¼Œé é¢å‘ä¸Šæ»¾å‹•');
                    return true;
                }
                
                // æ‰€æœ‰å…¶ä»–æƒ…æ³éƒ½ä¸è§¸ç™¼
                console.log(`âŒ ä¸ç¬¦åˆè§¸ç™¼æ¢ä»¶: é é¢${direction}æ»¾å‹• åœ¨ ${position} ä½ç½®`);
                return false;
            }
            
            // ä½¿ç”¨éŒ¨é»æª¢æ¸¬ä½ç½® - æ›´å¯é çš„æ–¹æ³•
            getRelativePosition() {
                const currentScroll = window.pageYOffset;
                const viewportHeight = window.innerHeight;
                const viewportCenter = currentScroll + (viewportHeight / 2);
                
                // ç²å–ä¸‰å€‹å€åŸŸçš„éŒ¨é»
                const section1 = document.querySelector('.section-1'); // ä¸Šæ–¹å€åŸŸ
                const slotMachine = document.querySelector('[data-name="slot-machine"]'); // è€è™æ©Ÿ
                const section3 = document.querySelector('.section-3'); // ä¸‹æ–¹å€åŸŸ
                
                if (!section1 || !slotMachine || !section3) return 'unknown';
                
                // è¨ˆç®—å„å€åŸŸçš„ä¸­å¿ƒé»
                const section1Rect = section1.getBoundingClientRect();
                const section1Center = section1Rect.top + currentScroll + (section1Rect.height / 2);
                
                const slotRect = slotMachine.getBoundingClientRect();
                const slotCenter = slotRect.top + currentScroll + (slotRect.height / 2);
                
                const section3Rect = section3.getBoundingClientRect();
                const section3Center = section3Rect.top + currentScroll + (section3Rect.height / 2);
                
                // åˆ¤æ–·è¦–çª—ä¸­å¿ƒæœ€æ¥è¿‘å“ªå€‹å€åŸŸçš„ä¸­å¿ƒ
                const distanceToSection1 = Math.abs(viewportCenter - section1Center);
                const distanceToSlot = Math.abs(viewportCenter - slotCenter);
                const distanceToSection3 = Math.abs(viewportCenter - section3Center);
                
                const minDistance = Math.min(distanceToSection1, distanceToSlot, distanceToSection3);
                
                if (minDistance === distanceToSection1) {
                    return 'above';
                } else if (minDistance === distanceToSlot) {
                    return 'within';
                } else {
                    return 'below';
                }
            }
            
            snapToTarget() {
                const target = document.querySelector('[data-name="slot-machine"]');
                if (!target) {
                    this.log('âŒ æ‰¾ä¸åˆ°ç›®æ¨™å…ƒç´ ');
                    return;
                }
                
                const rect = target.getBoundingClientRect();
                const currentScroll = window.pageYOffset;
                const targetTop = rect.top + currentScroll;
                
                this.log(`ğŸ¯ ç›®æ¨™ä½ç½®: ${targetTop}px (ç•¶å‰: ${currentScroll}px)`);
                
                // æ”¹é€²çš„æ»¾å‹•æ–¹æ³• - ä½¿ç”¨å¤šæ­¥é©Ÿç²¾ç¢ºå®šä½
                this.preciseScrollTo(targetTop);
            }
            
            // è‡ªå®šç¾©å¹³æ»‘æ»¾å‹• - ç²¾ç¢ºæ§åˆ¶
            preciseScrollTo(targetPosition) {
                const startPosition = window.pageYOffset;
                const distance = Math.abs(targetPosition - startPosition);
                const direction = targetPosition > startPosition ? 1 : -1;
                
                // é˜»æ­¢åŸç”Ÿæ»¾å‹•å¹²æ“¾
                document.body.style.overflow = 'hidden';
                
                this.log(`ğŸ¯ é–‹å§‹è‡ªå®šç¾©æ»¾å‹•: ${startPosition}px -> ${targetPosition}px`);
                
                // è‡ªå®šç¾©å‹•ç•«åƒæ•¸
                const duration = Math.min(300 + distance * 0.3, 500); // å‹•æ…‹æŒçºŒæ™‚é–“
                const startTime = performance.now();
                
                const animateScroll = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // ä½¿ç”¨ easeOutCubic ç·©å‹•å‡½æ•¸ï¼Œé¿å…æ»¾éé ­
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    
                    const currentPosition = startPosition + (targetPosition - startPosition) * easeProgress;
                    
                    window.scrollTo(0, currentPosition);
                    
                    if (progress < 1) {
                        requestAnimationFrame(animateScroll);
                    } else {
                        // å‹•ç•«å®Œæˆï¼Œç¢ºä¿ç²¾ç¢ºåˆ°ä½
                        window.scrollTo(0, targetPosition);
                        setTimeout(() => {
                            this.verifyScrollResult(targetPosition, startPosition);
                        }, 50);
                    }
                };
                
                requestAnimationFrame(animateScroll);
            }
            
            // é©—è­‰æ»¾å‹•çµæœ
            verifyScrollResult(targetPosition, startPosition) {
                // æ¢å¾©æ»¾å‹•
                document.body.style.overflow = '';
                
                const finalPosition = window.pageYOffset;
                const accuracy = Math.abs(finalPosition - targetPosition);
                const totalDistance = Math.abs(targetPosition - startPosition);
                
                // è¨˜éŒ„ç²¾åº¦çµ±è¨ˆ
                this.accuracyHistory.push(accuracy);
                const avgAccuracy = this.accuracyHistory.reduce((a, b) => a + b, 0) / this.accuracyHistory.length;
                
                // è¨˜éŒ„æŠ€è¡“è³‡è¨Š
                const techInfo = {
                    æ™‚é–“: new Date().toLocaleTimeString(),
                    é–‹å§‹ä½ç½®: Math.round(startPosition),
                    ç›®æ¨™ä½ç½®: Math.round(targetPosition),
                    æœ€çµ‚ä½ç½®: Math.round(finalPosition),
                    ç²¾åº¦: Math.round(accuracy * 100) / 100,
                    æ»¾å‹•è·é›¢: Math.round(totalDistance),
                    ä½ç½®ç‹€æ…‹: this.getRelativePosition()
                };
                
                this.techInfo.push(techInfo);
                
                // æ›´æ–° UI
                document.getElementById('last-accuracy').textContent = `${accuracy.toFixed(1)}px`;
                document.getElementById('avg-accuracy').textContent = `${avgAccuracy.toFixed(1)}px`;
                
                if (accuracy <= 10) {
                    this.log(`âœ… æ»¾å‹•æˆåŠŸ: ä½ç½®=${finalPosition.toFixed(1)}px, ç²¾åº¦=${accuracy.toFixed(1)}px`);
                } else {
                    this.log(`âš ï¸ ç²¾åº¦ä¸ä½³: ä½ç½®=${finalPosition.toFixed(1)}px, ç²¾åº¦=${accuracy.toFixed(1)}px`);
                }
                
                this.updatePosition();
            }
            
            updatePosition() {
                const position = this.getRelativePosition();
                document.getElementById('position').textContent = position;
            }
            
            log(message) {
                console.log(`[FixedScrollSnap] ${message}`);
                document.getElementById('status').textContent = message;
                document.getElementById('last-event').textContent = new Date().toLocaleTimeString();
            }
        }
        
        // è¤‡è£½æŠ€è¡“è³‡è¨ŠåŠŸèƒ½
        function copyTechInfo() {
            if (!window.fixedScrollSnap || !window.fixedScrollSnap.techInfo.length) {
                alert('é‚„æ²’æœ‰æŠ€è¡“è³‡è¨Šå¯è¤‡è£½');
                return;
            }
            
            const info = window.fixedScrollSnap.techInfo;
            const latest = info[info.length - 1];
            const avgAccuracy = window.fixedScrollSnap.accuracyHistory.reduce((a, b) => a + b, 0) / window.fixedScrollSnap.accuracyHistory.length;
            
            const techReport = `
ğŸ”§ æ»¾å‹•å¸é™„æŠ€è¡“å ±å‘Š
===================
æœ€æ–°æ¸¬è©¦çµæœ:
- æ™‚é–“: ${latest.æ™‚é–“}
- é–‹å§‹ä½ç½®: ${latest.é–‹å§‹ä½ç½®}px
- ç›®æ¨™ä½ç½®: ${latest.ç›®æ¨™ä½ç½®}px  
- æœ€çµ‚ä½ç½®: ${latest.æœ€çµ‚ä½ç½®}px
- ç²¾åº¦: ${latest.ç²¾åº¦}px
- æ»¾å‹•è·é›¢: ${latest.æ»¾å‹•è·é›¢}px
- ä½ç½®ç‹€æ…‹: ${latest.ä½ç½®ç‹€æ…‹}

çµ±è¨ˆè³‡è¨Š:
- ç¸½è§¸ç™¼æ¬¡æ•¸: ${window.fixedScrollSnap.triggerCount}
- å¹³å‡ç²¾åº¦: ${avgAccuracy.toFixed(1)}px
- æœ€ä½³ç²¾åº¦: ${Math.min(...window.fixedScrollSnap.accuracyHistory).toFixed(1)}px
- æœ€å·®ç²¾åº¦: ${Math.max(...window.fixedScrollSnap.accuracyHistory).toFixed(1)}px

ç€è¦½å™¨è³‡è¨Š:
- User Agent: ${navigator.userAgent}
- è¦–çª—å°ºå¯¸: ${window.innerWidth}x${window.innerHeight}
- è¨­å‚™åƒç´ æ¯”: ${window.devicePixelRatio}

æœ€è¿‘5æ¬¡æ¸¬è©¦:
${info.slice(-5).map(item => 
    `${item.æ™‚é–“}: ${item.é–‹å§‹ä½ç½®}px -> ${item.ç›®æ¨™ä½ç½®}px (ç²¾åº¦: ${item.ç²¾åº¦}px)`
).join('\n')}
            `.trim();
            
            navigator.clipboard.writeText(techReport).then(() => {
                alert('âœ… æŠ€è¡“è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿');
            }).catch(() => {
                // å‚™ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = techReport;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('âœ… æŠ€è¡“è³‡è¨Šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ (å‚™ç”¨æ–¹æ¡ˆ)');
            });
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.fixedScrollSnap = new FixedScrollSnap();
            
            // å®šæœŸæ›´æ–°ä½ç½®é¡¯ç¤º
            setInterval(() => {
                if (window.fixedScrollSnap && !window.fixedScrollSnap.isTracking) {
                    window.fixedScrollSnap.updatePosition();
                }
            }, 1000);
        });
    </script>
</body>
</html>