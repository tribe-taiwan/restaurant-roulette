<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å—é¤å»³ç‡Ÿæ¥­æ™‚é–“æ•¸æ“šå®Œæ•´æ€§æ¸¬è©¦</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin: 20px 0; 
        }
        .stat-card { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 8px; 
            border-left: 4px solid #007bff; 
        }
        .stat-number { 
            font-size: 2em; 
            font-weight: bold; 
            color: #007bff; 
        }
        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background-color: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 10px 0; 
        }
        .progress-fill { 
            height: 100%; 
            background-color: #28a745; 
            transition: width 0.3s ease; 
        }
        .log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 15px; 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
            margin-top: 20px; 
        }
        .restaurant-item { 
            padding: 8px; 
            margin: 2px 0; 
            border-radius: 3px; 
        }
        .has-hours { background-color: #d4edda; }
        .no-hours { background-color: #f8d7da; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .warning { color: #ffc107; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px 5px; 
        }
        button:hover { background: #0056b3; }
        button:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .alert { 
            padding: 15px; 
            margin: 20px 0; 
            border-radius: 5px; 
            border-left: 4px solid; 
        }
        .alert-info { 
            background-color: #d1ecf1; 
            border-color: #17a2b8; 
            color: #0c5460; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ´ å°å—é¤å»³ç‡Ÿæ¥­æ™‚é–“æ•¸æ“šå®Œæ•´æ€§æ¸¬è©¦</h1>
        
        <div class="alert alert-info">
            <strong>æ¸¬è©¦ç›®çš„ï¼š</strong>åˆ†æå°å—åœ°å€é¤å»³åœ¨ Google Maps ä¸Šç‡Ÿæ¥­æ™‚é–“æ•¸æ“šçš„å®Œæ•´æ€§ï¼Œäº†è§£æœ‰å¤šå°‘é¤å»³ç¼ºå°‘è©³ç´°ç‡Ÿæ¥­æ™‚é–“è³‡è¨Šã€‚
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalCount">0</div>
                <div>ç¸½æ¸¬è©¦é¤å»³æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="withHours">0</div>
                <div>æœ‰ç‡Ÿæ¥­æ™‚é–“æ•¸æ“š</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="withoutHours">0</div>
                <div>ç¼ºå°‘ç‡Ÿæ¥­æ™‚é–“æ•¸æ“š</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="coverage">0%</div>
                <div>æ•¸æ“šå®Œæ•´æ€§</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>

        <button onclick="startTest()" id="startBtn">é–‹å§‹æ¸¬è©¦ (100å®¶é¤å»³)</button>
        <button onclick="clearLog()" id="clearBtn">æ¸…é™¤æ—¥èªŒ</button>
        <button onclick="exportResults()" id="exportBtn" disabled>åŒ¯å‡ºçµæœ</button>

        <div class="log" id="log"></div>
    </div>

    <!-- å…ˆè¼‰å…¥ä¸»é …ç›®çš„ locationUtils.js ä¾†ç²å–å·²è™•ç†çš„ API Key -->
    <script src="./utils/locationUtils.js"></script>

    <script>
        // å¾ locationUtils.js ä¸­è®€å–å·²ç¶“è¢« GitHub Actions è™•ç†éçš„ API Key
        // ä¸éœ€è¦é‡æ–°å®šç¾© GOOGLE_PLACES_CONFIGï¼Œç›´æ¥ä½¿ç”¨ locationUtils.js ä¸­çš„

        // å°å—å¸‚ä¸­å¿ƒåº§æ¨™
        const TAINAN_CENTER = {
            lat: 22.9997,
            lng: 120.2270
        };

        let testPlacesService = null; // é‡å‘½åé¿å…èˆ‡ locationUtils.js è¡çª
        let testResults = [];
        let isTestRunning = false;

        // åˆå§‹åŒ– Google Maps API
        async function initializeGoogleMaps() {
            return new Promise((resolve, reject) => {
                if (window.google && window.google.maps) {
                    console.log('âœ… Google Maps API å·²è¼‰å…¥');
                    
                    const mapDiv = document.createElement('div');
                    mapDiv.style.display = 'none';
                    document.body.appendChild(mapDiv);
                    
                    const map = new google.maps.Map(mapDiv, {
                        center: TAINAN_CENTER,
                        zoom: 15
                    });
                    
                    testPlacesService = new google.maps.places.PlacesService(map);
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_PLACES_CONFIG.API_KEY}&libraries=places&callback=onGoogleMapsLoaded`;
                script.async = true;
                script.defer = true;
                
                window.onGoogleMapsLoaded = () => {
                    try {
                        const mapDiv = document.createElement('div');
                        mapDiv.style.display = 'none';
                        document.body.appendChild(mapDiv);

                        const map = new google.maps.Map(mapDiv, {
                            center: TAINAN_CENTER,
                            zoom: 15
                        });

                        testPlacesService = new google.maps.places.PlacesService(map);
                        log('âœ… Google Maps API åˆå§‹åŒ–å®Œæˆ', 'success');
                        resolve();
                    } catch (error) {
                        log('âŒ Google Maps API åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                        reject(error);
                    }
                };

                script.onerror = () => reject(new Error('Google Maps API è¼‰å…¥å¤±æ•—'));
                document.head.appendChild(script);
            });
        }

        // æœç´¢é™„è¿‘é¤å»³
        async function searchRestaurants(location, radius = 5000) {
            return new Promise((resolve, reject) => {
                const request = {
                    location: new google.maps.LatLng(location.lat, location.lng),
                    radius: radius,
                    type: 'restaurant'
                };
                
                testPlacesService.nearbySearch(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        resolve(results);
                    } else {
                        reject(new Error(`æœç´¢å¤±æ•—: ${status}`));
                    }
                });
            });
        }

        // ç²å–é¤å»³è©³ç´°è³‡è¨Š
        async function getPlaceDetails(placeId) {
            return new Promise((resolve) => {
                const request = {
                    placeId: placeId,
                    fields: ['name', 'formatted_address', 'opening_hours', 'place_id', 'rating', 'user_ratings_total']
                };
                
                testPlacesService.getDetails(request, (place, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK) {
                        resolve(place);
                    } else {
                        resolve(null);
                    }
                });
            });
        }

        // æ—¥èªŒå‡½æ•¸
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            const total = testResults.length;
            const withHours = testResults.filter(r => r.hasOpeningHours).length;
            const withoutHours = total - withHours;
            const coverage = total > 0 ? Math.round((withHours / total) * 100) : 0;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('withHours').textContent = withHours;
            document.getElementById('withoutHours').textContent = withoutHours;
            document.getElementById('coverage').textContent = coverage + '%';
            document.getElementById('progressFill').style.width = (total / 100) * 100 + '%';
        }

        // é–‹å§‹æ¸¬è©¦
        async function startTest() {
            if (isTestRunning) return;
            isTestRunning = true;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('exportBtn').disabled = true;
            testResults = [];
            updateStats();
            
            log('ğŸš€ é–‹å§‹æ¸¬è©¦å°å—é¤å»³ç‡Ÿæ¥­æ™‚é–“æ•¸æ“šå®Œæ•´æ€§', 'success');
            
            try {
                // åˆå§‹åŒ– API
                await initializeGoogleMaps();
                
                // æœç´¢é¤å»³
                log('ğŸ” æœç´¢å°å—åœ°å€é¤å»³...', 'info');
                const restaurants = await searchRestaurants(TAINAN_CENTER, 8000);
                log(`ğŸ“ æ‰¾åˆ° ${restaurants.length} å®¶é¤å»³ï¼Œé–‹å§‹åˆ†æå‰ 100 å®¶...`, 'success');
                
                // é™åˆ¶åˆ° 100 å®¶
                const testRestaurants = restaurants.slice(0, 100);
                
                // æ‰¹æ¬¡è™•ç†ï¼Œé¿å… API é™åˆ¶
                const batchSize = 5;
                for (let i = 0; i < testRestaurants.length; i += batchSize) {
                    const batch = testRestaurants.slice(i, Math.min(i + batchSize, testRestaurants.length));
                    
                    await Promise.all(batch.map(async (restaurant, batchIndex) => {
                        const index = i + batchIndex + 1;
                        try {
                            log(`[${index}/100] åˆ†æé¤å»³: ${restaurant.name}`, 'info');
                            
                            const details = await getPlaceDetails(restaurant.place_id);
                            
                            const hasOpeningHours = !!(details && details.opening_hours && 
                                (details.opening_hours.periods || 
                                 details.opening_hours.weekday_text || 
                                 typeof details.opening_hours.isOpen === 'function'));
                            
                            const result = {
                                name: restaurant.name,
                                placeId: restaurant.place_id,
                                address: details?.formatted_address || 'åœ°å€æœªçŸ¥',
                                rating: details?.rating || 0,
                                reviewCount: details?.user_ratings_total || 0,
                                hasOpeningHours: hasOpeningHours,
                                openingHoursData: details?.opening_hours || null
                            };
                            
                            testResults.push(result);
                            updateStats();
                            
                            const statusIcon = hasOpeningHours ? 'âœ…' : 'âŒ';
                            const hoursInfo = hasOpeningHours ? 'æœ‰ç‡Ÿæ¥­æ™‚é–“' : 'ç¼ºå°‘ç‡Ÿæ¥­æ™‚é–“';
                            log(`${statusIcon} ${restaurant.name} - ${hoursInfo}`, hasOpeningHours ? 'success' : 'warning');
                            
                        } catch (error) {
                            log(`âŒ åˆ†æé¤å»³ ${restaurant.name} å¤±æ•—: ${error.message}`, 'error');
                        }
                    }));
                    
                    // æ‰¹æ¬¡é–“å»¶é²ï¼Œé¿å… API é™åˆ¶
                    if (i + batchSize < testRestaurants.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // æ¸¬è©¦å®Œæˆ
                const finalStats = {
                    total: testResults.length,
                    withHours: testResults.filter(r => r.hasOpeningHours).length,
                    withoutHours: testResults.filter(r => !r.hasOpeningHours).length,
                    coverage: Math.round((testResults.filter(r => r.hasOpeningHours).length / testResults.length) * 100)
                };
                
                log('ğŸ‰ æ¸¬è©¦å®Œæˆï¼', 'success');
                log(`ğŸ“Š çµ±è¨ˆçµæœ:`, 'info');
                log(`   â€¢ ç¸½æ¸¬è©¦é¤å»³: ${finalStats.total} å®¶`, 'info');
                log(`   â€¢ æœ‰ç‡Ÿæ¥­æ™‚é–“æ•¸æ“š: ${finalStats.withHours} å®¶ (${finalStats.coverage}%)`, 'success');
                log(`   â€¢ ç¼ºå°‘ç‡Ÿæ¥­æ™‚é–“æ•¸æ“š: ${finalStats.withoutHours} å®¶ (${100 - finalStats.coverage}%)`, 'warning');
                
                if (finalStats.coverage < 70) {
                    log(`âš ï¸  è­¦å‘Š: æ•¸æ“šå®Œæ•´æ€§åƒ… ${finalStats.coverage}%ï¼Œå¤§é‡é¤å»³ç¼ºå°‘ç‡Ÿæ¥­æ™‚é–“è³‡è¨Šï¼`, 'error');
                } else if (finalStats.coverage < 85) {
                    log(`âš ï¸  æ³¨æ„: æ•¸æ“šå®Œæ•´æ€§ ${finalStats.coverage}%ï¼Œä»æœ‰ä¸å°‘é¤å»³ç¼ºå°‘ç‡Ÿæ¥­æ™‚é–“è³‡è¨Š`, 'warning');
                } else {
                    log(`âœ… è‰¯å¥½: æ•¸æ“šå®Œæ•´æ€§ ${finalStats.coverage}%ï¼Œå¤§éƒ¨åˆ†é¤å»³éƒ½æœ‰ç‡Ÿæ¥­æ™‚é–“è³‡è¨Š`, 'success');
                }
                
                document.getElementById('exportBtn').disabled = false;
                
            } catch (error) {
                log(`âŒ æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, 'error');
            }
            
            isTestRunning = false;
            document.getElementById('startBtn').disabled = false;
        }

        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // åŒ¯å‡ºçµæœ
        function exportResults() {
            if (testResults.length === 0) {
                alert('æ²’æœ‰æ¸¬è©¦çµæœå¯ä»¥åŒ¯å‡º');
                return;
            }

            const csvContent = [
                ['é¤å»³åç¨±', 'åœ°å€', 'è©•åˆ†', 'è©•è«–æ•¸', 'æ˜¯å¦æœ‰ç‡Ÿæ¥­æ™‚é–“', 'ç‡Ÿæ¥­æ™‚é–“æ•¸æ“šé¡å‹'].join(','),
                ...testResults.map(result => [
                    `"${result.name}"`,
                    `"${result.address}"`,
                    result.rating,
                    result.reviewCount,
                    result.hasOpeningHours ? 'æ˜¯' : 'å¦',
                    result.hasOpeningHours ? 
                        (result.openingHoursData?.periods ? 'periods' : 
                         result.openingHoursData?.weekday_text ? 'weekday_text' : 
                         typeof result.openingHoursData?.isOpen === 'function' ? 'isOpenæ–¹æ³•' : 'å…¶ä»–') : 
                        'ç„¡'
                ].join(','))
            ].join('\n');

            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `å°å—é¤å»³ç‡Ÿæ¥­æ™‚é–“æ•¸æ“šåˆ†æ_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>