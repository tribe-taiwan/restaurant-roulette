# 毛玻璃導航功能修復指南

## 問題描述

候選餐廳列表中的毛玻璃區域點擊功能失效，無法正確打開路線導航，而是跳轉到一般的 Google Maps 搜尋頁面。

## 根本原因分析

通過創建測試檔案 `test-frosted-glass.html` 進行對比分析，發現問題出在：

### 1. 參數傳遞缺失
**SlotMachine 組件缺少必要的參數傳遞**

- **組件定義需要**：`userLocation` 和 `userAddress` 參數
- **實際調用缺少**：app.js 中的 SlotMachine 組件調用沒有傳遞這兩個參數
- **結果**：`getDirectionsUrl` 函數中的 `userLocation` 和 `userAddress` 都是 `undefined`

### 2. 技術細節對比

| 組件 | 測試檔案（正常） | 生產版本（有問題） |
|------|------------------|-------------------|
| 事件處理 | `e.stopPropagation()` ✅ | `e.stopPropagation()` ✅ |
| 參數傳遞 | 模擬完整參數 ✅ | 缺少 `userLocation`, `userAddress` ❌ |
| CSS 層級 | `pointer-events-none` ✅ | `pointer-events-none` ✅ |
| URL 生成 | 完整導航URL ✅ | 缺少起點信息 ❌ |

## 修復步驟

### 步驟 1：創建測試檔案進行驗證

創建 `test-frosted-glass.html` 來驗證毛玻璃點擊邏輯：

```html
<!-- 模擬候選餐廳項目結構 -->
<a href="一般地圖搜尋URL" class="restaurant-item">
    <div class="frosted-glass-panel" onclick="handleNavigation()">
        <!-- 毛玻璃內容 -->
    </div>
</a>
```

```javascript
// 關鍵邏輯驗證
panel.addEventListener('click', function(e) {
    e.stopPropagation(); // ✅ 阻止事件冒泡
    window.open(getDirectionsUrl(restaurant), '_blank');
});
```

### 步驟 2：對比分析發現問題

通過對比測試檔案和生產版本的 SlotMachine 組件調用：

**問題代碼**：
```javascript
// app.js - 缺少參數
<SlotMachine 
  isSpinning={isSpinning}
  onSpin={handleSpin}
  // ... 其他參數
  // ❌ 缺少 userLocation={userLocation}
  // ❌ 缺少 userAddress={userAddress}
/>
```

### 步驟 3：修復參數傳遞

**修復代碼**：
```javascript
// app.js - 添加缺少的參數
<SlotMachine 
  isSpinning={isSpinning}
  onSpin={handleSpin}
  onAddCandidate={handleAddCandidate}
  translations={t}
  finalRestaurant={currentRestaurant}
  candidateList={candidateList}
  language={selectedLanguage}
  onClearList={handleClearList}
  onImageClick={handleImageClick}
  userLocation={userLocation}     // ✅ 新增
  userAddress={userAddress}       // ✅ 新增
/>
```

### 步驟 4：驗證修復結果

修復後的行為：
- **點擊毛玻璃區域** → `getDirectionsUrl()` 獲取正確的 `userLocation` 和 `userAddress` → 生成路線導航URL → 開啟 Google Maps 路線規劃
- **點擊其他區域** → 外層 `<a>` 標籤觸發 → 開啟一般地圖搜尋

## 技術實作細節

### 毛玻璃組件結構

```javascript
// SlotMachine.js - 候選餐廳項目
<a href="一般地圖搜尋URL" target="_blank">
  {/* 毛玻璃導航面板 */}
  <div 
    className="frosted-glass-panel"
    style={{
      width: '38.2%', // 黃金比例
      background: 'linear-gradient(...)', // 漸層背景
      backdropFilter: 'blur(12px)', // 毛玻璃效果
      WebkitBackdropFilter: 'blur(12px)', // Safari 支援
    }}
    onClick={(e) => {
      e.stopPropagation(); // 阻止事件冒泡到外層<a>標籤
      window.open(getDirectionsUrl(restaurant), '_blank');
    }}
  >
    <div className="pointer-events-none"> {/* 子元素不干擾點擊 */}
      {/* 餐廳資訊顯示 */}
    </div>
  </div>
</a>
```

### 導航URL生成函數

```javascript
// SlotMachine.js - getDirectionsUrl 函數
const getDirectionsUrl = (restaurant) => {
  // 優先使用userAddress作為起點
  if (userAddress && restaurant.address) {
    const origin = encodeURIComponent(userAddress);
    const destination = encodeURIComponent(restaurant.address);
    return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&hl=${language === 'zh' ? 'zh-TW' : 'en'}`;
  }
  
  // 回退到座標
  if (userLocation && restaurant.address) {
    const origin = encodeURIComponent(`${userLocation.lat},${userLocation.lng}`);
    const destination = encodeURIComponent(restaurant.address);
    return `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}&hl=${language === 'zh' ? 'zh-TW' : 'en'}`;
  }
  
  // 最終回退
  return restaurant.googleMapsUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(restaurant.name + ',' + restaurant.address)}`;
};
```

## 常見問題排解

### Q1: 毛玻璃點擊沒有反應
**檢查項目**：
1. 確認 `userLocation` 和 `userAddress` 參數是否正確傳遞
2. 檢查 Console 是否有 JavaScript 錯誤
3. 驗證 `getDirectionsUrl` 函數是否正常執行

### Q2: 點擊毛玻璃仍跳轉到一般地圖搜尋
**可能原因**：
1. `e.stopPropagation()` 沒有正確執行
2. 子元素的 `pointer-events` 設定錯誤
3. CSS 層級衝突

### Q3: 導航URL不正確
**檢查項目**：
1. 確認 `userLocation` 和 `userAddress` 不是 `undefined`
2. 檢查 `restaurant.address` 是否存在
3. 驗證 URL 編碼是否正確

## 測試驗證方法

### 1. 使用測試檔案
開啟 `test-frosted-glass.html` 進行功能測試

### 2. Console 調試
```javascript
// 在毛玻璃點擊事件中添加調試
onClick={(e) => {
  console.log('🔍 毛玻璃點擊事件觸發');
  console.log('📍 userLocation:', userLocation);
  console.log('🏠 userAddress:', userAddress);
  console.log('🍴 restaurant:', restaurant);
  
  e.stopPropagation();
  const url = getDirectionsUrl(restaurant);
  console.log('🗺️ 生成的導航URL:', url);
  window.open(url, '_blank');
}}
```

### 3. 功能測試清單
- [ ] 點擊毛玻璃區域開啟路線導航
- [ ] 點擊毛玻璃外區域開啟一般地圖搜尋
- [ ] 導航URL包含正確的起點和終點
- [ ] 支援多語言導航介面
- [ ] 毛玻璃視覺效果正常顯示

## 相關檔案

- `components/SlotMachine.js` - 毛玻璃組件實作
- `app.js` - 組件參數傳遞
- `test-frosted-glass.html` - 功能測試檔案
- `components/RestaurantCard.js` - 參考實作

## 總結

毛玻璃導航功能的修復關鍵在於**確保參數正確傳遞**。通過測試檔案驗證邏輯正確性，然後針對性地修復參數傳遞問題，最終實現了預期的導航功能。

此修復方法具有通用性，可應用於類似的組件參數傳遞問題。