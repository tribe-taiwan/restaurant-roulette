# 老虎機滑動動畫修復任務

## 問題描述
用戶反映老虎機的圖片左滑時出現黑畫面問題：
- **預期行為**：新圖片應該從右邊緊跟著當前圖片滑入，當前圖片完全消失時新圖片變成當前圖片
- **實際問題**：經常出現一段黑畫面，然後才顯示新圖片
- **核心原因**：API圖片載入延遲導致滑動動畫開始時新圖片還未準備好
- **當前狀況**：原始黑畫面問題未修復，還增加了在黑畫面上轉圈圈的問題

## 測試環境設置

### 主要測試工具
```
測試檔案：http://127.0.0.1:3001/test/test-slide-transition.html
主應用：http://127.0.0.1:3001
啟動命令：npm run dev (會在 port 3001 運行，如 3000 被占用)
```

### 測試檔特色
- **使用真實API圖片**：`https://picsum.photos/` 隨機圖片API，模擬真實網絡延遲
- **完整預載入邏輯**：實現滑動窗口預載入策略
- **詳細Console日誌**：可在F12查看圖片載入狀態
- **狀態指示器**：顯示當前圖片索引和動畫狀態

## 核心文件結構

### 主要組件
```
components/SlotMachine.js - 老虎機主組件 (728行)
├── 滑動轉場函數 (第62-134行)
├── 預載入邏輯 (第136-233行)  
├── 滑動動畫渲染 (第448-525行)
└── 預載入指示器 (第607-613行)
```

### CSS動畫定義
```
index.html (第126-160行)
├── slideInFromRight - 從右滑入
├── slideInFromLeft - 從左滑入  
├── slideOutToLeft - 向左滑出
└── slideOutToRight - 向右滑出
```

## 技術分析

### 當前實現問題
1. **預載入時機錯誤**：在點擊時才開始預載入，等於沒有預載入效果
2. **狀態管理混亂**：`isPreloading` 狀態與滑動動畫沒有正確協調
3. **圖片檢查不足**：沒有確保圖片完全載入就開始滑動動畫
4. **複雜化問題**：最近的修改讓黑畫面上還出現轉圈，問題更嚴重

### 預載入策略分析
```javascript
// 目前的錯誤方式 (即時載入)
triggerSlideTransition -> 開始預載入 -> 顯示轉圈 -> 動畫開始

// 正確的方式 (提前預載)  
背景預載入池維護 -> 點擊切換 -> 檢查已預載 -> 立即動畫
```

### 滑動窗口概念
- **目標**：維持前後各5張圖片(共10張)已預載狀態
- **觸發時機**：每次餐廳位置改變時
- **清理策略**：超過3張超出範圍的圖片才清理，優先清理距離遠的
- **記憶體控制**：避免無限累積，但保持合理緩存大小




## 調試工具

### Console 日誌關鍵字
```
🔄 滑動轉場觸發 - 動畫開始
✅ 圖片已預載 - 無需載入  
⏳ 開始預載入 - 需要載入
❌ 滑動轉場被阻止 - 衝突檢測
🧹 智能清理 - 記憶體管理
```

### 瀏覽器開發工具
- **Network標籤**：查看圖片載入時間和狀態
- **Performance標籤**：分析動畫性能和卡頓點
- **Memory標籤**：監控記憶體使用和洩漏

## 最近失敗的修改

### 問題修改
1. **複雜化預載入邏輯**：添加了複雜的滑動窗口邏輯
2. **狀態管理混亂**：多個預載入狀態相互衝突
3. **用戶體驗更差**：黑畫面上出現轉圈，更加明顯
4. **沒有解決根本問題**：黑畫面依然存在

### 錯誤的方向
- 在滑動動畫觸發時才開始預載入（應該提前預載）
- 複雜的記憶體管理（應該先解決基本問題）
- 過度設計的狀態追蹤（增加了複雜度但沒解決問題）

## 注意事項

### 不要修改的部分
- **CSS動畫定義** (index.html第126-160行) - 動畫本身是正確的
- **基本滑動邏輯** - 觸控和鍵盤事件處理
- **候選清單功能** - 與滑動動畫無關的功能

---

**最後更新**: 2025-08-08  
**當前狀況**: 黑畫面問題未修復，還增加了轉圈問題  
**測試環境**: http://127.0.0.1:3001/test/test-slide-transition.html  
